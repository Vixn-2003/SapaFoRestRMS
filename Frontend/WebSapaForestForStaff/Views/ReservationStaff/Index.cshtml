@model ReservationListViewModel
@{
    Layout = "_LayoutManager";
    ViewData["Title"] = "Quản lý đặt bàn - Nhà hàng Sapa Forest";
}

<!-- Liên kết CSS riêng -->
<link rel="stylesheet" href="~/css/reservation-list.css" />

<div class="container py-4 reservation-page">
    <h2><i class="bi bi-journal-text me-2"></i>Danh sách đơn đặt bàn</h2>
    @if (TempData["CancelReservationError"] != null)
{
    <div class="alert alert-danger">@TempData["CancelReservationError"]</div>
}
@if (TempData["CancelReservationSuccess"] != null)
{
    <div class="alert alert-success">@TempData["CancelReservationSuccess"]</div>
}
    <div class="card p-3 mb-3 card-filter">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-2">
                <label class="form-label">Trạng thái</label>
                <select name="status" class="form-select">
                    <option value="">-- Tất cả --</option>
                    <option value="Pending" selected="@(ViewBag.Status == "Pending")">Chờ xử lý</option>
                    <option value="Confirmed" selected="@(ViewBag.Status == "Confirmed")">Đã xác nhận</option>
                     <option value="Cancelled" selected="@(ViewBag.Status == "Cancelled")">Đã Hủy</option>
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Tên khách hàng</label>
                <input type="text" name="customerName" value="@ViewBag.CustomerName" class="form-control" placeholder="Nhập tên khách hàng..." />
            </div>

            <div class="col-md-3">
                <label class="form-label">Số điện thoại</label>
                <input type="text" name="phone" value="@ViewBag.Phone" class="form-control" placeholder="Nhập SĐT..." />
            </div>

            <div class="col-md-2">
                <label class="form-label">Ngày đặt</label>
                <input type="date" name="reservationDate" value="@ViewBag.ReservationDate" class="form-control" />
            </div>

            <div class="col-md-2">
                <label class="form-label">Ca</label>
                <select name="timeSlot" class="form-select">
                    <option value="">-- Tất cả --</option>
                    <option value="Ca sáng" selected="@(ViewBag.TimeSlot == "Ca sáng")">Ca sáng</option>
                    <option value="Ca trưa" selected="@(ViewBag.TimeSlot == "Ca trưa")">Ca trưa</option>
                    <option value="Ca tối" selected="@(ViewBag.TimeSlot == "Ca tối")">Ca tối</option>
                </select>
            </div>

            <div class="col-md-12 text-end">
                <button type="submit" class="btn btn-primary px-4 me-2">
                    <i class="bi bi-funnel"></i> Lọc
                </button>
                <a href="@Url.Action("Index")" class="btn btn-secondary px-4">
                    <i class="bi bi-arrow-repeat"></i> Reset
                </a>
            </div>
        </form>
    </div>

    <div class="mb-3 text-end">
        <a asp-action="CreateReservation" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Tạo đơn tại quầy
        </a>
    </div>

    <table class="table table-hover table-bordered align-middle">
        <thead>
            <tr>
                <th>Mã đơn</th>
                <th>Tên khách hàng</th>
                <th>SĐT</th>
                <th>Ngày đặt</th>
                <th>Ca</th>
                <th>Số người</th>
                 <th>Đặt cọc (VND)</th>
                <th>Trạng thái</th>
                <th class="text-center">Thao tác</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Data != null && Model.Data.Any())
            {
                foreach (var r in Model.Data)
                {
                    <tr>
                        <td class="text-center fw-semibold">@r.ReservationId</td>
                        <td>@r.CustomerName</td>
                        <td>@r.CustomerPhone</td>
                        <td class="text-center">@r.ReservationDate.ToString("dd/MM/yyyy")</td>
                        <td class="text-center">@r.TimeSlot</td>
                        <td class="text-center">@r.NumberOfGuests</td>
                         <td>
                    @if (r.DepositAmount.HasValue && r.DepositAmount.Value > 0)
                    {
                        @String.Format("{0:N0}", r.DepositAmount) 
                    }
                    else
                    {
                        <span class="text-muted">Chưa cọc/Không cần cọc </span>
                    }
                </td>
                        <td class="text-center">
                           <span class="badge @(r.Status == "Pending" ? "bg-warning text-dark" 
                 : r.Status == "Confirmed" ? "bg-success" 
                 : "bg-danger")">
    @(r.Status == "Pending" ? "Chờ xử lý" 
      : r.Status == "Confirmed" ? "Đã xác nhận" 
      : "Đã hủy")
</span>

                        </td>
                        <td class="text-center">
                            <a class="btn btn-sm btn-outline-primary" href="@Url.Action("AssignTables", "ReservationStaff", new { id = r.ReservationId })">
                                <i class="bi bi-clipboard-check"></i> Xếp bàn 
                            </a>
                             <form asp-action="CancelReservation" asp-controller="ReservationStaff"
          method="post" class="d-inline">
        <input type="hidden" name="id" value="@r.ReservationId" />
        <input type="hidden" name="refund" value="false" />
        <button type="submit" class="btn btn-sm btn-outline-danger"
                onclick="return confirm('Xác nhận hủy đơn KHÔNG hoàn cọc?');">
            <i class="bi bi-x-circle"></i> Hủy
        </button>
    </form>

    <!-- Nút Hủy + Hoàn cọc -->
    <form asp-action="CancelReservation" asp-controller="ReservationStaff"
          method="post" class="d-inline">
        <input type="hidden" name="id" value="@r.ReservationId" />
        <input type="hidden" name="refund" value="true" />
        <button type="submit" class="btn btn-sm btn-outline-success"
                onclick="return confirm('Xác nhận HỦY ĐƠN và HOÀN CỌC cho khách hàng?');">
            <i class="bi bi-check-circle"></i> Hủy + Hoàn cọc
        </button>
    </form>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr><td colspan="8" class="text-center text-muted py-3">Không có dữ liệu phù hợp</td></tr>
            }
        </tbody>
    </table>

    @if (Model.TotalPages > 1)
    {
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    <li class="page-item @(i == Model.Page ? "active" : "")">
                        <a class="page-link"
                           href="@Url.Action("Index", new {
                               status = ViewBag.Status,
                               customerName = ViewBag.CustomerName,
                               phone = ViewBag.Phone,
                               reservationDate = ViewBag.ReservationDate,
                               timeSlot = ViewBag.TimeSlot,
                               page = i
                           })">
                            @i
                        </a>
                    </li>
                }
            </ul>
        </nav>
    }
</div>
