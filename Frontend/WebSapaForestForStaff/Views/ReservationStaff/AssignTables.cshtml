@{
    var reservation = ViewBag.Reservation as ReservationStaffViewModel;
    var areas = ViewBag.Areas as List<AreaViewModel>;
    var bookedTableIds = ViewBag.BookedTableIds as List<int> ?? new List<int>();
    var suggestedTableIdsByArea = ViewBag.SuggestedTableIdsByArea as Dictionary<int, List<int>>
                                 ?? new Dictionary<int, List<int>>();
}

<link rel="stylesheet" href="~/css/assign-tables.css" />

<h2>🌿 Xử lý xếp bàn</h2>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}
@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

<div class="card p-3 mb-3" style="display:flex; flex-direction:row; gap:20px; flex-wrap:nowrap; align-items:flex-start;">
    <!-- Bên trái: Thông tin khách hàng -->
    <div style="flex:1; min-width:250px;">
        <strong>Tên khách hàng:</strong> @reservation.CustomerName <br />
        <strong>SĐT:</strong> @reservation.CustomerPhone <br />
        <strong>Ngày:</strong> @reservation.ReservationDate.ToString("dd/MM/yyyy") <br />
        <strong>Ca:</strong> @reservation.TimeSlot <br />
        <strong>Giờ đến :</strong> @reservation.ReservationTime.ToString("HH:mm") <br />
        <strong>Số khách:</strong> @reservation.NumberOfGuests <br />
        <strong>Lưu ý của khách hàng - Notes :</strong> @(string.IsNullOrWhiteSpace(@reservation.Notes) ? "Không có lưu ý gì" : @reservation.Notes) <br />
        <strong>Bàn lần xử lý trước:</strong>
        @(
                reservation.Tables != null && reservation.Tables.Any()
                ? string.Join(", ", reservation.Tables.Select(t => t.TableNumber))
                : "Không có bàn nào được đặt ở lần xử lý trước đó"
                )
    </div>

    <!-- Bên phải: Thống kê bàn trống & sức chứa -->
    <div style="flex:1; min-width:250px;">
        <h5>📊 Thống kê khu vực</h5>
        @foreach (var area in areas)
        {
            var tablesInArea = area.Tables;
            var freeTables = tablesInArea.Where(t => !bookedTableIds.Contains(t.TableId)).ToList();
            var remainingCapacity = freeTables.Sum(t => t.Capacity);

            <div class="mb-2 p-2 border rounded area-summary" style="background:#f0fdf4; cursor:pointer;"
                 data-area-id="@area.AreaId">
                <strong>@area.AreaName</strong> -
                Số bàn trống: <strong>@freeTables.Count</strong> -
                Sức chứa còn lại: <strong>@remainingCapacity</strong> chỗ
            </div>

        }
    </div>
</div>


@if (suggestedTableIdsByArea.Any())
{
    <div class="alert alert-info">
        <strong>🪑 Bàn gợi ý :</strong>
        @foreach (var area in areas)
        {
            if (suggestedTableIdsByArea.ContainsKey(area.AreaId))
            {
                var tables = area.Tables
                .Where(t => suggestedTableIdsByArea[area.AreaId].Contains(t.TableId))
                .Select(t => t.TableName);
                if (tables.Any())
                {
                    <span>@area.AreaName: @string.Join(", ", tables)</span>
    
                    <br />
                }
            }
        }
    </div>
}

<form asp-action="AssignTablesPost" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" name="ReservationId" value="@reservation.ReservationId" />

    <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="text-success">Chọn bàn</h4>
        <select id="filterSelect" class="form-select w-auto">
            <option value="all">Tất cả</option>
            <option value="available">Bàn trống</option>
            <option value="booked">Đang đặt</option>
            <option value="suggested">Gợi ý</option>
        </select>
    </div>

    @foreach (var area in areas)
    {
        <div class="mb-3 area-block" data-area-id="@area.AreaId">
            <strong style="color:#2e572f;">@area.AreaName</strong>
            <div class="d-flex flex-wrap mt-2">
                @foreach (var table in area.Tables)
                {
                    var isBooked = bookedTableIds.Contains(table.TableId);
                    var isSuggested = suggestedTableIdsByArea.ContainsKey(area.AreaId)
                    && suggestedTableIdsByArea[area.AreaId].Contains(table.TableId);

                    string labelClass = isBooked ? "btn btn-danger disabled"
                    : isSuggested ? "btn btn-primary"
                    : "btn btn-outline-success";

                    string filterType = isBooked ? "booked"
                    : isSuggested ? "suggested"
                    : "available";

                    <label class="@labelClass table-item" data-type="@filterType">
                        <input type="checkbox" name="TableIds" value="@table.TableId"
                               @(isBooked ? "disabled" : "") />
                        @table.TableName (@table.Capacity chỗ)
                    </label>
                }
            </div>
        </div>
    }

    <div class="form-check mt-4">
        <input type="checkbox" class="form-check-input" name="RequireDeposit" id="depositCheck" value="true" />
        <label class="form-check-label" for="depositCheck">Yêu cầu đặt cọc</label>

        <input type="number" id="depositAmount" name="DepositAmount"
               class="form-control mt-2"
               placeholder="Số tiền đặt cọc (VND)" step="0.01" />

        <button type="button" id="sendDepositBtn" class="btn btn-info mt-3" style="display:none;">
            💬 Gửi yêu cầu đặt cọc
        </button>
    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-success me-2">✅ Xác nhận gán bàn</button>
        <button type="submit" formaction="@Url.Action("ResetTables")" formmethod="post" class="btn btn-warning me-2">
            🔄 Reset bàn
        </button>
        <a class="btn btn-secondary" href="@Url.Action("Index")">⬅ Quay lại</a>
    </div>
</form>

<script>
    const depositCheck = document.getElementById("depositCheck");
    const sendBtn = document.getElementById("sendDepositBtn");

    depositCheck.addEventListener("change", function () {
        sendBtn.style.display = this.checked ? "inline-block" : "none";
    });

    sendBtn.addEventListener("click", async () => {
        const depositAmount = document.getElementById("depositAmount").value;
        if (!depositAmount || depositAmount <= 0) {
            alert("Vui lòng nhập số tiền đặt cọc hợp lệ!");
            return;
        }

        const reservationId = "@reservation.ReservationId";
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

        const response = await fetch(`/ReservationStaff/SendDepositRequest`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "RequestVerificationToken": token
            },
            body: JSON.stringify({
                reservationId: reservationId,
                depositAmount: depositAmount
            })
        });

        const result = await response.json();
        alert(result.message);
    });

        // --- Lọc theo khu vực khi click vào thống kê ---
    document.querySelectorAll(".area-summary").forEach(summary => {
        summary.addEventListener("click", () => {
            const areaId = summary.getAttribute("data-area-id");
            document.querySelectorAll(".area-block").forEach(block => {
                if (block.getAttribute("data-area-id") === areaId) {
                    block.style.display = "block";
                } else {
                    block.style.display = "none";
                }
            });
        });
    });
    // --- Lọc bàn ---
    const filterSelect = document.getElementById("filterSelect");
    filterSelect.addEventListener("change", () => {
        const value = filterSelect.value;
        document.querySelectorAll(".table-item").forEach(item => {
            const type = item.getAttribute("data-type");

            // ✅ Logic lọc mới
            if (value === "all") {
                item.style.display = "inline-block";
                // Hiện toàn bộ khu vực
            document.querySelectorAll(".area-block").forEach(block => block.style.display = "block");
            }
            else if (value === "available") {
                // Bàn trống = bàn available + suggested
                item.style.display = (type === "available" || type === "suggested")
                    ? "inline-block" : "none";
            }
            else if (value === "booked") {
                item.style.display = (type === "booked") ? "inline-block" : "none";
            }
            else if (value === "suggested") {
                item.style.display = (type === "suggested") ? "inline-block" : "none";
            }
        });
    });
</script>

