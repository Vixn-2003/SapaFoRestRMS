@using WebSapaForestForStaff.DTOs;
@{
    Layout = "_LayoutInventory";
    ViewData["Title"] = "Quản Lý Nhập Hàng";
}

@model WebSapaForestForStaff.DTOs.InventoryPagedViewModel

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background-color: #f9fafb;
        color: #111827;
    }

    .container {
        min-height: 100vh;
        padding: 1.5rem;
    }

    .max-width {
        max-width: 100rem;
        margin: 0 auto;
    }

    .card {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .header-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.5rem;
    }

    .header-subtitle {
        font-size: 0.875rem;
        color: #6b7280;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
    }

    @@media (min-width: 768px) {
        .filter-grid {
            grid-template-columns: repeat(6, 1fr);
        }
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .form-input, .form-select {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        outline: none;
        transition: all 0.15s;
    }

    .form-input:focus, .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .button-group {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1.5rem;
        border: none;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
        text-decoration: none;
    }

    .btn-primary {
        background-color: #3b82f6;
        color: white;
    }

    .btn-primary:hover {
        background-color: #2563eb;
    }

    .btn-success {
        background-color: #10b981;
        color: white;
    }

    .btn-success:hover {
        background-color: #059669;
    }

    .btn-danger {
        background-color: #ef4444;
        color: white;
    }

    .btn-danger:hover {
        background-color: #dc2626;
    }

    .table-container {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .table-wrapper {
        overflow-x: auto;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
    }

    .table thead {
        background-color: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }

    .table th {
        padding: 0.75rem 1rem;
        text-align: center;
        font-size: 0.75rem;
        font-weight: 500;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .table tbody tr {
        border-bottom: 1px solid #e5e7eb;
        transition: background-color 0.15s;
    }

    .table tbody tr:hover {
        background-color: #f9fafb;
    }

    .table td {
        text-align: center;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
    }

    .table td.text-right {
        text-align: right;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        align-items: center;
    }

    .action-btn {
        padding: 0.25rem;
        border: none;
        background: transparent;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: background-color 0.15s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .action-btn i {
        font-size: 1rem;
    }

    .action-btn.view {
        color: #9333ea;
    }

    .action-btn.view:hover {
        background-color: #faf5ff;
    }

    .pagination {
        padding: 0.75rem 1rem;
        border-top: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .pagination-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .pagination-text {
        font-size: 0.875rem;
        color: #374151;
    }

    .pagination-btn {
        padding: 0.25rem 0.5rem;
        border: 1px solid #d1d5db;
        background: white;
        border-radius: 0.25rem;
        cursor: pointer;
        font-size: 0.875rem;
        transition: background-color 0.15s;
        text-decoration: none;
        color: #374151;
    }

    .pagination-btn:hover:not(.disabled) {
        background-color: #f9fafb;
    }

    .pagination-btn.active {
        background-color: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .pagination-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

    .pagination-info {
        font-size: 0.875rem;
        color: #374151;
    }

    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .fa-spinner.fa-spin {
        animation: spin 1s linear infinite;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        width: 900px;
        max-width: 95%;
        max-height: 90vh;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease-out;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        padding: 1.5rem 2rem;
        border-bottom: 2px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px 12px 0 0;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .modal-body {
        padding: 2rem;
        overflow-y: auto;
        flex: 1;
    }

    .modal-footer {
        padding: 1rem 2rem;
        border-top: 2px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        background-color: #f9fafb;
        border-radius: 0 0 12px 12px;
    }

    .close-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.4);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 1.5rem;
        cursor: pointer;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .close-btn:hover {
        background: rgba(239, 68, 68, 0.9);
        border-color: #ef4444;
        transform: rotate(90deg);
    }

    .info-header {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        padding: 1.5rem;
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
    }

    .info-header p {
        margin: 0.5rem 0;
        font-size: 1rem;
        color: #1e40af;
        display: flex;
        align-items: center;
    }

    .info-header strong {
        font-weight: 600;
        color: #1e3a8a;
        min-width: 140px;
    }

    .info-header span {
        font-weight: 500;
        color: #1f2937;
        background: white;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
    }

    .batch-table-container {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #e5e7eb;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .batch-table {
        width: 100%;
        border-collapse: collapse;
    }

    .batch-table thead {
        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
    }

    .batch-table thead tr {
        border-bottom: 2px solid #d1d5db;
    }

    .batch-table th {
        padding: 1rem;
        text-align: left;
        font-size: 0.8rem;
        font-weight: 600;
        color: #374151;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .batch-table tbody tr {
        border-bottom: 1px solid #f3f4f6;
        transition: all 0.2s;
    }

    .batch-table tbody tr:hover {
        background-color: #fef3c7;
    }

    .batch-table td {
        padding: 1rem;
        font-size: 0.875rem;
        color: #4b5563;
    }

    /* Warehouse Select Styles */
    .warehouse-select {
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        background-color: white;
        cursor: pointer;
        min-width: 150px;
        transition: all 0.2s;
    }

    .warehouse-select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .warehouse-select.changed {
        border-color: #f59e0b;
        background-color: #fffbeb;
    }

    .btn-save-warehouse {
        padding: 0.4rem 0.8rem;
        background-color: #10b981;
        color: white;
        border: none;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
        display: none;
    }

    .btn-save-warehouse:hover {
        background-color: #059669;
        transform: translateY(-1px);
    }

    .btn-save-warehouse.show {
        display: inline-block;
    }

    /* Confirmation popup */
    .confirm-popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
    }

    .confirm-content {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        max-width: 400px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .confirm-content h3 {
        margin-bottom: 1rem;
        color: #1f2937;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .confirm-content p {
        margin-bottom: 1.5rem;
        color: #6b7280;
        line-height: 1.6;
    }

    .confirm-buttons {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
    }

    @@keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* Alert/Notification Styles */
.alert {
    padding: 1rem 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.875rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    animation: slideDown 0.3s ease-out;
    position: relative;
}

.alert-error {
    background-color: #fee2e2;
    border-left: 4px solid #ef4444;
    color: #991b1b;
}

.alert-info {
    background-color: #dbeafe;
    border-left: 4px solid #3b82f6;
    color: #1e40af;
}

.alert-success {
    background-color: #d1fae5;
    border-left: 4px solid #10b981;
    color: #065f46;
}

.alert-close {
    background: transparent;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    /* ... */
}

@@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@@keyframes slideUp {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-20px);
    }
}

    .action-btn.edit {
        color: #3b82f6;
    }

        .action-btn.edit:hover {
            background-color: #eff6ff;
        }

    /* Edit Modal Styles */
    .edit-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1001;
        backdrop-filter: blur(4px);
    }

        .edit-modal-overlay.active {
            display: flex;
        }

    .edit-modal-content {
        background: white;
        border-radius: 12px;
        width: 500px;
        max-width: 95%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease-out;
    }

    .edit-modal-header {
        padding: 1.5rem 2rem;
        border-bottom: 2px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border-radius: 12px 12px 0 0;
    }

        .edit-modal-header h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

    .edit-modal-body {
        padding: 2rem;
    }

    .edit-form-group {
        margin-bottom: 1.5rem;
    }

    .edit-form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .edit-form-input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        transition: all 0.2s;
    }

        .edit-form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .edit-form-input:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }

    .edit-modal-footer {
        padding: 1rem 2rem;
        border-top: 2px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        background-color: #f9fafb;
        border-radius: 0 0 12px 12px;
    }
</style>

<div class="container">
    <div class="max-width">
        <!-- Notification messages -->
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-error" id="alertMessage">
                <i class="fas fa-exclamation-circle"></i>
                <span>@TempData["ErrorMessage"]</span>
                <button class="alert-close" onclick="closeAlert()">&times;</button>
            </div>
        }

        @if (TempData["InfoMessage"] != null)
        {
            <div class="alert alert-info" id="alertMessage">
                <i class="fas fa-info-circle"></i>
                <span>@TempData["InfoMessage"]</span>
                <button class="alert-close" onclick="closeAlert()">&times;</button>
            </div>
        }

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success" id="alertMessage">
                <i class="fas fa-check-circle"></i>
                <span>@TempData["SuccessMessage"]</span>
                <button class="alert-close" onclick="closeAlert()">&times;</button>
            </div>
        }
        <div class="card">
            <h1 class="header-title">Nguyên liệu</h1>
            <p class="header-subtitle">Quản lý thông tin nguyên liệu</p>
        </div>

        <form method="post" asp-controller="ManagerIngredent" asp-action="FilterIngredent" class="card">
            @Html.AntiForgeryToken()
            <div class="filter-grid">
                <div class="form-group">
                    <label class="form-label">Tìm kiếm</label>
                    <input type="text"
                           placeholder="Nhập tên nguyên liệu hoặc mã nguyên liệu"
                           name="searchIngredent"
                           class="form-input"
                           value="@Model.SearchIngredent" />
                </div>

                <div class="form-group">
                    <label class="form-label">Từ ngày</label>
                    <input type="date" name="fromDate" class="form-input"
                           value="@((Model.FromDate ?? DateTime.Now.AddDays(-7)).ToString("yyyy-MM-dd"))" />
                </div>

                <div class="form-group">
                    <label class="form-label">Đến ngày</label>
                    <input type="date" name="toDate" class="form-input"
                           value="@((Model.ToDate ?? DateTime.Now).ToString("yyyy-MM-dd"))" />
                </div>
            </div>

            <div class="button-group">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter"></i> Tìm Kiếm
                </button>
                <a href="/ImportInventory" class="btn btn-success">
                    <i class="fas fa-plus"></i> Thêm nguyên liệu
                </a>
            </div>
        </form>

        <div class="table-container">
            <div class="table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mã nguyên liệu</th>
                            <th>Tên nguyên liệu</th>
                            <th>Đơn vị tính</th>
                            <th class="text-right">SL tồn</th>
                            <th class="text-right">Tồn đầu kỳ</th>
                            <th class="text-right">SL nhập</th>
                            <th class="text-right">SL xuất</th>
                            <th class="text-center">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Ingredients == null || !Model.Ingredients.Any())
                        {
                            <tr>
                                <td colspan="9" style="text-align:center; padding:3rem; color:#6b7280;">
                                    <i class="fas fa-inbox" style="font-size:3rem; color:#d1d5db; margin-bottom:1rem;"></i>
                                    <br>
                                    <strong style="font-size:1.1rem; color:#374151;">Không tìm thấy nguyên liệu nào</strong>
                                    <br>
                                    <span style="font-size:0.875rem;">Vui lòng thử lại với điều kiện tìm kiếm khác</span>
                                </td>
                            </tr>
                        }
                        else
                        {
                            int stt = (Model.CurrentPage - 1) * Model.ItemsPerPage + 1;

                            @foreach (var item in Model.Ingredients)
                            {
                                <tr>
                                    <td>@stt</td>
                                    <td>@item.IngredientCode</td>
                                    <td>@item.Name</td>
                                    <td>@(item.Unit?.UnitName ?? "---")</td>
                                    <td class="text-right">@item.TotalQuantity</td>
                                    <td class="text-right">@item.OriginalQuantity</td>
                                    <td class="text-right">@item.TotalImport</td>
                                    <td class="text-right">@item.TotalExport</td>
                                    <td class="text-center">
                                        <div class="action-buttons">
                                            <a href="#"
                                               data-ingredient-id="@item.IngredientId"
                                               data-ingredient-code="@item.IngredientCode"
                                               data-ingredient-name="@item.Name"
                                               data-ingredient-unit="@(item.Unit?.UnitName ?? "---")"
                                               data-ingredient-unit-id="@(item.Unit?.UnitId ?? 0)"
                                               class="action-btn view"
                                               title="Xem chi tiết"
                                               onclick="showIngredientDetailFromRow(this); return false;">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button onclick="openEditModal('@item.IngredientId', '@item.Name', '@(item.Unit?.UnitName ?? "---")', '@(item.Unit?.UnitId ?? 0)')"
                                                    class="action-btn edit"
                                                    title="Chỉnh sửa">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                stt++;
                            }
                        }
                    </tbody>
                </table>
            </div>

            <div class="pagination">
                <div class="pagination-controls">
                    <span class="pagination-text">Trang</span>
                    <a asp-action="FilterIngredent"
                       asp-route-page="@(Model.CurrentPage - 1)"
                       asp-route-fromDate="@Model.FromDate?.ToString("yyyy-MM-dd")"
                       asp-route-toDate="@Model.ToDate?.ToString("yyyy-MM-dd")"
                       asp-route-searchIngredent="@Model.SearchIngredent"
                       class="pagination-btn @(Model.CurrentPage <= 1 ? "disabled" : "")">
                        &lt;
                    </a>
                    <span class="pagination-btn active">@Model.CurrentPage</span>
                    <a asp-action="FilterIngredent"
                       asp-route-page="@(Model.CurrentPage + 1)"
                       asp-route-fromDate="@Model.FromDate?.ToString("yyyy-MM-dd")"
                       asp-route-toDate="@Model.ToDate?.ToString("yyyy-MM-dd")"
                       asp-route-searchIngredent="@Model.SearchIngredent"
                       class="pagination-btn @(Model.CurrentPage * Model.ItemsPerPage >= Model.TotalItems ? "disabled" : "")">
                        &gt;
                    </a>
                </div>
                <div class="pagination-info">
                    Hiển thị @((Model.CurrentPage - 1) * Model.ItemsPerPage + 1)
                    -
                    @Math.Min(Model.CurrentPage * Model.ItemsPerPage, Model.TotalItems)
                    trên @Model.TotalItems kết quả
                </div>
            </div>
        </div>
    </div>

    <!-- Modal chi tiết nguyên liệu -->
    <div id="ingredientModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Chi tiết nguyên liệu</h2>
                <button id="closeModal" class="close-btn">&times;</button>
            </div>

            <div class="modal-body">
                <div class="info-header">
                    <p><strong>Tên nguyên liệu:</strong> <span id="mName">---</span></p>
                    <p><strong>Đơn vị tính:</strong> <span id="mUnit">---</span></p>
                </div>
                <hr>
                <h4 style="margin-top: 1rem; color:#1f2937;">Danh sách các lô nhập</h4>
                <div class="batch-table-container">
                    <table class="batch-table">
                        <thead>
                            <tr>
                                <th>Mã lô</th>
                                <th>Nhà cung cấp</th>
                                <th>Ngày nhập</th>
                                <th>Hạn sử dụng</th>
                                <th>Số lượng còn</th>
                                <th>Thuộc kho</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="batchTableBody">
                            <tr><td colspan="7" style="text-align:center;">Chưa có dữ liệu</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" onclick="openEditModalFromDetail()">
                    <i class="fas fa-edit"></i> Chỉnh sửa
                </button>
                <button id="closeModalFooter" class="btn btn-danger">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Modal chỉnh sửa nguyên liệu -->
    <div id="editIngredientModal" class="edit-modal-overlay">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h2>
                    <i class="fas fa-edit"></i>
                    Chỉnh sửa nguyên liệu
                </h2>
                <button id="closeEditModal" class="close-btn">&times;</button>
            </div>

            <div class="edit-modal-body">
                <form id="editIngredientForm">
                    <input type="hidden" id="editIngredientId">

                    <div class="edit-form-group">
                        <label class="edit-form-label">
                            <i class="fas fa-hashtag"></i> Mã nguyên liệu
                        </label>
                        <input type="text"
                               id="editIngredientCode"
                               class="edit-form-input"
                               disabled>
                    </div>

                    <div class="edit-form-group">
                        <label class="edit-form-label">
                            <i class="fas fa-box"></i> Tên nguyên liệu
                        </label>
                        <input type="text"
                               id="editIngredientName"
                               class="edit-form-input"
                               placeholder="Nhập tên nguyên liệu"
                               required>
                    </div>

                    <div class="edit-form-group">
                        <label class="edit-form-label">
                            <i class="fas fa-ruler"></i> Đơn vị tính
                        </label>
                        <select id="editIngredientUnit"
                                class="edit-form-input"
                                required
                                style="cursor: pointer;">
                            <option value="">-- Chọn đơn vị tính --</option>
                            @foreach (var unit in Model.Units)
                            {
                                <option value="@unit.UnitId">@unit.UnitName</option>
                            }
                        </select>
                    </div>
                </form>
            </div>

            <div class="edit-modal-footer">
                <button class="btn btn-danger" onclick="closeEditIngredientModal()">
                    <i class="fas fa-times"></i> Hủy
                </button>
                <button class="btn btn-success" id="saveEditBtn">
                    <i class="fas fa-save"></i> Lưu thay đổi
                </button>
            </div>
        </div>
    </div>
</div>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

<script>
    let warehouseList = [];

    // Load warehouse list khi trang được tải
    async function loadWarehouses() {
        try {
            const response = await fetch('/api/Warehouse/GetAll');
            if (response.ok) {
                warehouseList = await response.json();
                console.log('Loaded warehouses:', warehouseList);
            }
        } catch (error) {
            console.error('Error loading warehouses:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadWarehouses();
        const alert = document.getElementById('alertMessage');
    if (alert) {
        setTimeout(() => closeAlert(), 5000);
    }
        const searchInput = document.querySelector('input[name="searchIngredent"]');
        const tableBody = document.querySelector('.table tbody');
        const modal = document.getElementById("ingredientModal");
        const closeBtns = [document.getElementById("closeModal"), document.getElementById("closeModalFooter")];

        closeBtns.forEach(btn => {
            if (btn) {
                btn.addEventListener("click", () => modal.style.display = "none");
            }
        });

        window.addEventListener("click", e => {
            if (e.target === modal) modal.style.display = "none";
        });

    });


    function openEditModalFromDetail() {
        const modal = document.getElementById("ingredientModal");

        // Lấy thông tin đã lưu trong modal
        const ingredientId = modal.getAttribute('data-ingredient-id');
        const ingredientCode = modal.getAttribute('data-ingredient-code');
        const ingredientName = modal.getAttribute('data-ingredient-name');
        const ingredientUnit = modal.getAttribute('data-ingredient-unit');
        const ingredientUnitId = modal.getAttribute('data-ingredient-unit-id'); // ← THÊM DÒNG NÀY

        // Điền dữ liệu vào form edit
        document.getElementById('editIngredientId').value = ingredientId;
        document.getElementById('editIngredientCode').value = ingredientCode;
        document.getElementById('editIngredientName').value = ingredientName;

        // Set UnitId (int) vào select
        document.getElementById('editIngredientUnit').value = ingredientUnitId; // ← SỬA DÒNG NÀY

        // Đóng modal detail
        modal.style.display = "none";

        // Mở modal edit
        document.getElementById('editIngredientModal').classList.add('active');
    }

    async function showIngredientDetail(ingredientId) {
        const modal = document.getElementById("ingredientModal");
        const tbody = document.getElementById("batchTableBody");
        const url = `/api/InventoryIngredient/BatchIngredient/${ingredientId}`;

        try {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align:center;padding:2rem;">
                        <i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...
                    </td>
                </tr>
            `;
            modal.style.display = "flex";

            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const data = await response.json();
            console.log("Batch data received:", data);

            if (!Array.isArray(data) || data.length === 0) {
                displayNoData(tbody);
                return;
            }

            // Display ingredient info
            const firstBatch = data[0];
            document.getElementById("mName").textContent = firstBatch.ingredientName || "---";
            document.getElementById("mUnit").textContent = firstBatch.ingredientUnit || "---";

            // Clear and populate table
            tbody.innerHTML = "";

            data.forEach((batch) => {
                const row = document.createElement("tr");
                row.dataset.batchId = batch.batchId;
                row.dataset.originalWarehouseId = batch.warehouseId;

                const createdDate = formatDate(batch.createdAt);
                const expiryDate = formatDate(batch.expiryDate);
                const quantity = formatNumber(batch.quantityRemaining);

                // Tạo options cho select từ warehouse list
                const warehouseOptions = warehouseList
                    .filter(w => w.isActive)
                    .map(w => `<option value="${w.warehouseId}" ${w.warehouseId === batch.warehouseId ? 'selected' : ''}>${w.name}</option>`)
                    .join('');

                row.innerHTML = `
                        <td style="font-weight: 600; color: #3b82f6;">${batch.purchaseOrderId}</td>
                    <td>${batch.supplierName || 'N/A'}</td>
                    <td>${createdDate}</td>
                    <td>${expiryDate}</td>
                    <td style="text-align: right; font-weight: 500;">${quantity}</td>
                    <td>
                        <select class="warehouse-select" data-batch-id="${batch.batchId}">
                            ${warehouseOptions}
                        </select>
                    </td>
                    <td style="text-align: center;">
                        <button class="btn-save-warehouse" data-batch-id="${batch.batchId}">
                            <i class="fas fa-save"></i> Lưu
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });

            attachWarehouseEventListeners();
            console.log(`Successfully displayed ${data.length} batches`);

        } catch (error) {
            console.error("Error:", error);
            displayError(tbody, error.message);
        }
    }

    function attachWarehouseEventListeners() {
        // Lắng nghe sự kiện thay đổi warehouse
        document.querySelectorAll('.warehouse-select').forEach(select => {
            select.addEventListener('change', function() {
                const row = this.closest('tr');
                const originalWarehouseId = parseInt(row.dataset.originalWarehouseId);
                const newWarehouseId = parseInt(this.value);
                const saveBtn = row.querySelector('.btn-save-warehouse');

                if (newWarehouseId !== originalWarehouseId) {
                    this.classList.add('changed');
                    saveBtn.classList.add('show');
                } else {
                    this.classList.remove('changed');
                    saveBtn.classList.remove('show');
                }
            });
        });

        // Lắng nghe sự kiện click nút Lưu
        document.querySelectorAll('.btn-save-warehouse').forEach(btn => {
            btn.addEventListener('click', function () {
                const batchId = this.dataset.batchId;
                const row = this.closest('tr');
                const purchaseOrderId = row.querySelector('td:first-child').textContent; // ← LẤY TEXT TỪ CỘT ĐẦU TIÊN
                const select = row.querySelector('.warehouse-select');
                const newWarehouseId = parseInt(select.value);
                const newWarehouseName = select.options[select.selectedIndex].text;

                showConfirmDialog(batchId, purchaseOrderId, newWarehouseId, newWarehouseName, row);
            });
        });
    }

    function showConfirmDialog(batchId, purchaseOrderId, newWarehouseId, newWarehouseName, row) {
        const confirmHtml = `
            <div class="confirm-popup" id="confirmPopup">
                <div class="confirm-content">
                    <h3>
                        <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
                        Xác nhận thay đổi kho
                    </h3>
                    <p>
                        Bạn có chắc chắn muốn chuyển lô <strong>#${purchaseOrderId}</strong>
                        sang kho <strong>${newWarehouseName}</strong>?
                    </p>
                    <div class="confirm-buttons">
                        <button class="btn btn-danger" id="cancelBtn">
                            <i class="fas fa-times"></i> Hủy
                        </button>
                        <button class="btn btn-success" id="confirmBtn">
                            <i class="fas fa-check"></i> Xác nhận
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', confirmHtml);

        const popup = document.getElementById('confirmPopup');
        const cancelBtn = document.getElementById('cancelBtn');
        const confirmBtn = document.getElementById('confirmBtn');

        cancelBtn.addEventListener('click', () => {
            popup.remove();
        });

        confirmBtn.addEventListener('click', async () => {
            try {
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';

                await updateBatchWarehouse(batchId, newWarehouseId, row);

                popup.remove();
            } catch (error) {
                alert('Có lỗi xảy ra: ' + error.message);
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="fas fa-check"></i> Xác nhận';
            }
        });
    }

    async function updateBatchWarehouse(batchId, newWarehouseId, row) {
        try {
            const response = await fetch('/ManagerIngredent/UpdateBatchWarehouse', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    batchId: batchId,
                    warehouseId: newWarehouseId
                })
            });

            if (!response.ok) {
                throw new Error('Không thể cập nhật kho');
            }

            const result = await response.json();

            if (result.success) {
                row.dataset.originalWarehouseId = newWarehouseId;
                const select = row.querySelector('.warehouse-select');
                const saveBtn = row.querySelector('.btn-save-warehouse');

                select.classList.remove('changed');
                saveBtn.classList.remove('show');

                showSuccessMessage('Cập nhật kho thành công!');
            } else {
                throw new Error(result.message || 'Có lỗi xảy ra');
            }

        } catch (error) {
            console.error('Error updating warehouse:', error);
            throw error;
        }
    }

    function showSuccessMessage(message) {
        const successHtml = `
            <div style="position: fixed; top: 20px; right: 20px; background: #10b981; color: white;
                        padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 10000; animation: slideIn 0.3s ease-out;" id="successMsg">
                <i class="fas fa-check-circle"></i> ${message}
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', successHtml);

        setTimeout(() => {
            const msg = document.getElementById('successMsg');
            if (msg) msg.remove();
        }, 3000);
    }

    function formatDate(dateValue) {
        if (!dateValue) return 'N/A';

        try {
            let date;
            if (typeof dateValue === 'string') {
                if (dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    date = new Date(dateValue + 'T00:00:00');
                } else {
                    date = new Date(dateValue);
                }
            } else {
                date = new Date(dateValue);
            }

            if (isNaN(date.getTime())) return 'N/A';

            return date.toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        } catch (e) {
            return 'N/A';
        }
    }

    function formatNumber(value) {
        if (value === null || value === undefined) return '0.00';

        try {
            const num = Number(value);
            if (isNaN(num)) return '0.00';
            return num.toLocaleString('vi-VN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        } catch (e) {
            return '0.00';
        }
    }

    function displayNoData(tbody) {
        document.getElementById("mName").textContent = "---";
        document.getElementById("mUnit").textContent = "---";
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align:center;padding:2rem;color:#9ca3af;">
                    <i class="fas fa-inbox"></i><br>
                    Không có dữ liệu lô nhập
                </td>
            </tr>
        `;
    }

    function displayError(tbody, message) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align:center;padding:2rem;color:#ef4444;">
                    <i class="fas fa-exclamation-circle"></i><br>
                    Có lỗi xảy ra: ${message}
                </td>
            </tr>
        `;
    }

    // Function to close alert
function closeAlert() {
    const alert = document.getElementById('alertMessage');
    if (alert) {
        alert.style.animation = 'slideUp 0.3s ease-out';
        setTimeout(() => alert.remove(), 300);
    }
}


    // ===== EDIT INGREDIENT FUNCTIONS =====

    function openEditModal(ingredientId, ingredientName, ingredientUnit, ingredientUnitId) {
        const row = event.target.closest('tr');
        const ingredientCode = row.cells[1].textContent;

        document.getElementById('editIngredientId').value = ingredientId;
        document.getElementById('editIngredientCode').value = ingredientCode;
        document.getElementById('editIngredientName').value = ingredientName;

        // Trực tiếp set value = UnitId
        document.getElementById('editIngredientUnit').value = ingredientUnitId;

        document.getElementById('editIngredientModal').classList.add('active');
    }

    function closeEditIngredientModal() {
        document.getElementById('editIngredientModal').classList.remove('active');
        document.getElementById('editIngredientForm').reset();
    }

    // Đóng modal khi click vào nút X
    document.getElementById('closeEditModal')?.addEventListener('click', closeEditIngredientModal);

    // Đóng modal khi click ra ngoài
    document.getElementById('editIngredientModal')?.addEventListener('click', function (e) {
        if (e.target === this) {
            closeEditIngredientModal();
        }
    });

    // Xử lý lưu thay đổi
    document.getElementById('saveEditBtn')?.addEventListener('click', async function () {
        const ingredientId = document.getElementById('editIngredientId').value;
        const ingredientName = document.getElementById('editIngredientName').value.trim();
        const ingredientUnitId = document.getElementById('editIngredientUnit').value; // ← Đổi tên biến

        // Validation
        if (!ingredientName) {
            alert('Vui lòng nhập tên nguyên liệu!');
            document.getElementById('editIngredientName').focus();
            return;
        }

        if (!ingredientUnitId) { // ← Đổi tên biến
            alert('Vui lòng chọn đơn vị tính!');
            document.getElementById('editIngredientUnit').focus();
            return;
        }

        // Hiển thị loading
        const saveBtn = document.getElementById('saveEditBtn');
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';

        try {
            const response = await fetch('/ManagerIngredent/UpdateIngredient', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ingredientId: parseInt(ingredientId),
                    name: ingredientName,
                    unitId: parseInt(ingredientUnitId) 
                })
            });

            if (!response.ok) {
                throw new Error('Không thể kết nối đến server');
            }

            const result = await response.json();

            if (result.success) {
                showSuccessMessage(result.message || 'Cập nhật nguyên liệu thành công!');
                closeEditIngredientModal();
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                throw new Error(result.message || 'Có lỗi xảy ra');
            }

        } catch (error) {
            console.error('Error updating ingredient:', error);
            alert('Có lỗi xảy ra: ' + error.message);
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    });

    // Xử lý phím ESC để đóng modal
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeEditIngredientModal();
        }
    });


    function showIngredientDetailFromRow(button) {
        // Lấy thông tin từ data attributes
        const ingredientId = button.getAttribute('data-ingredient-id');
        const ingredientCode = button.getAttribute('data-ingredient-code');
        const ingredientName = button.getAttribute('data-ingredient-name');
        const ingredientUnit = button.getAttribute('data-ingredient-unit');
        const ingredientUnitId = button.getAttribute('data-ingredient-unit-id'); // ← THÊM DÒNG NÀY

        // Hiển thị thông tin nguyên liệu ngay lập tức
        document.getElementById("mName").textContent = ingredientName || "---";
        document.getElementById("mUnit").textContent = ingredientUnit || "---";

        // Lưu thông tin vào modal để dùng cho Edit
        const modal = document.getElementById("ingredientModal");
        modal.setAttribute('data-ingredient-id', ingredientId);
        modal.setAttribute('data-ingredient-code', ingredientCode);
        modal.setAttribute('data-ingredient-name', ingredientName);
        modal.setAttribute('data-ingredient-unit', ingredientUnit);
        modal.setAttribute('data-ingredient-unit-id', ingredientUnitId); // ← THÊM DÒNG NÀY

        // Gọi function load batch
        loadBatchList(ingredientId);
    }

    // ===== LOAD DANH SÁCH BATCH =====
    async function loadBatchList(ingredientId) {
        const modal = document.getElementById("ingredientModal");
        const tbody = document.getElementById("batchTableBody");
        const url = `/api/InventoryIngredient/BatchIngredient/${ingredientId}`;

        try {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align:center;padding:2rem;">
                        <i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...
                    </td>
                </tr>
            `;
            modal.style.display = "flex";

            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const data = await response.json();
            console.log("Batch data received:", data);

            if (!Array.isArray(data) || data.length === 0) {
                displayNoData(tbody);
                return;
            }

            // Clear and populate table
            tbody.innerHTML = "";

            data.forEach((batch) => {
                const row = document.createElement("tr");
                row.dataset.batchId = batch.batchId;
                row.dataset.originalWarehouseId = batch.warehouseId;

                const createdDate = formatDate(batch.createdAt);
                const expiryDate = formatDate(batch.expiryDate);
                const quantity = formatNumber(batch.quantityRemaining);

                // Tạo options cho select từ warehouse list
                const warehouseOptions = warehouseList
                    .filter(w => w.isActive)
                    .map(w => `<option value="${w.warehouseId}" ${w.warehouseId === batch.warehouseId ? 'selected' : ''}>${w.name}</option>`)
                    .join('');

                row.innerHTML = `
                    <td style="font-weight: 600; color: #3b82f6;">${batch.purchaseOrderId}</td>
                    <td>${batch.supplierName || 'N/A'}</td>
                    <td>${createdDate}</td>
                    <td>${expiryDate}</td>
                    <td style="text-align: right; font-weight: 500;">${quantity}</td>
                    <td>
                        <select class="warehouse-select" data-batch-id="${batch.batchId}">
                            ${warehouseOptions}
                        </select>
                    </td>
                    <td style="text-align: center;">
                        <button class="btn-save-warehouse" data-batch-id="${batch.batchId}">
                            <i class="fas fa-save"></i> Lưu
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });

            attachWarehouseEventListeners();
            console.log(`Successfully displayed ${data.length} batches`);

        } catch (error) {
            console.error("Error:", error);
            displayError(tbody, error.message);
        }
    }
</script>