@* ⭐️ Dùng @model để nhận dữ liệu từ Controller *@
@model WebSapaForestForStaff.DTOs.OrderGuest.ListOrder.ReservationListViewModel

@{
    ViewData["Title"] = "Danh sách Đặt bàn";
    // Lấy giá trị filter để điền lại vào form
    string currentSearch = ViewData["CurrentSearch"] as string;
    string currentStatus = ViewData["CurrentStatus"] as string ?? "all";
    int currentPage = Model.Pagination.PageNumber;
    int totalPages = (int)Math.Ceiling((double)Model.Pagination.TotalCount / Model.Pagination.PageSize);
    Layout = "~/Views/Shared/_counterstaffLayout.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root {
        --primary-orange: #ff7b00;
        --primary-orange-hover: #e67e22;
        --active-purple: #594a87;
        --bg-light: #f5f7fa;
        --text-dark: #333;
        --card-radius: 16px;
    }

    body {
        background-color: var(--bg-light);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: var(--text-dark);
    }

    /* --- Page Header --- */
    .page-header-container {
        background: white;
        padding: 15px 25px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .page-title {
        font-weight: 700;
        color: var(--active-purple);
        margin: 0;
        font-size: 1.5rem;
    }

    /* --- Filter Bar (Style giống Search Box POS) --- */
    .filter-card {
        background: white;
        border-radius: var(--card-radius);
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: none;
    }

    .search-box-wrapper {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 20px;
        padding: 8px 15px;
        display: flex;
        align-items: center;
        transition: 0.2s;
    }

        .search-box-wrapper:focus-within {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255, 123, 0, 0.1);
        }

        .search-box-wrapper input {
            border: none;
            outline: none;
            width: 100%;
            margin-left: 10px;
            font-size: 14px;
        }

        .search-box-wrapper select {
            border: none;
            outline: none;
            background: transparent;
            font-size: 14px;
            width: 100%;
            margin-left: 10px;
            color: #555;
        }

    /* --- Table Styling --- */
    .table-card {
        background: white;
        border-radius: var(--card-radius);
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: none;
    }

    .custom-table {
        margin-bottom: 0;
        width: 100%;
    }

        .custom-table thead th {
            background-color: #f8f9fa;
            color: var(--active-purple);
            font-weight: 700;
            border-bottom: 2px solid #eee;
            padding: 15px;
            font-size: 14px;
        }

        .custom-table tbody td {
            padding: 15px;
            vertical-align: middle;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .custom-table tbody tr:hover {
            background-color: #fffcf5; /* Màu cam rất nhạt khi hover */
        }

    /* --- Status Badges --- */
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
    }

    .status-confirmed {
        background-color: #fff0e6;
        color: var(--primary-orange);
        border: 1px solid #ffccaa;
    }

    .status-guest-seated {
        background-color: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
    }

    .status-cancelled {
        background-color: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
    }

    /* --- Buttons --- */
    .btn-pos-primary {
        background-color: var(--primary-orange);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 8px 20px;
        font-weight: 600;
        transition: 0.2s;
    }

        .btn-pos-primary:hover {
            background-color: var(--primary-orange-hover);
            color: white;
        }

    .btn-detail-view {
        background-color: #f0f2f5;
        color: var(--active-purple);
        border: none;
        width: 35px;
        height: 35px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
    }

        .btn-detail-view:hover {
            background-color: var(--active-purple);
            color: white;
        }

    /* --- Pagination --- */
    .pagination-container {
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        border-top: 1px solid #eee;
    }

    .page-btn {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        border: 1px solid #eee;
        color: var(--text-dark);
        background: white;
        text-decoration: none;
        margin: 0 3px;
        transition: 0.2s;
    }

        .page-btn:hover {
            border-color: var(--primary-orange);
            color: var(--primary-orange);
        }

        .page-btn.disabled {
            opacity: 0.5;
            pointer-events: none;
            background: #f5f5f5;
        }

    /* --- Modal Custom (Giữ cấu trúc cũ nhưng style lại) --- */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(3px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1050;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

        .modal-overlay.show {
            opacity: 1;
        }

    .modal-popup {
        background: white;
        width: 650px;
        max-width: 90%;
        border-radius: var(--card-radius);
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        overflow: hidden;
        transform: translateY(20px);
        transition: transform 0.3s ease;
    }

    .modal-overlay.show .modal-popup {
        transform: translateY(0);
    }

    .modal-header-custom {
        background: var(--active-purple);
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .modal-header-custom h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

    .modal-close {
        cursor: pointer;
        font-size: 20px;
        color: rgba(255,255,255,0.8);
    }

        .modal-close:hover {
            color: white;
        }

    .modal-body-custom {
        padding: 25px;
        max-height: 70vh;
        overflow-y: auto;
    }

    .detail-section h3 {
        font-size: 15px;
        font-weight: 700;
        color: var(--primary-orange);
        text-transform: uppercase;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }

    .detail-item strong {
        color: #666;
        font-size: 13px;
        display: block;
    }

    .detail-item span {
        color: #333;
        font-weight: 600;
        font-size: 14px;
    }

    .detail-item.full-width {
        grid-column: span 2;
    }

    .modal-footer-custom {
        padding: 15px 20px;
        background: #f8f9fa;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
</style>

<div class="page-header-container">
    <h1 class="page-title"><i class="fa-regular fa-calendar-check me-2"></i>Danh sách Đặt bàn</h1>
    <div class="text-muted small">
        @DateTime.Now.ToString("dd/MM/yyyy HH:mm")
    </div>
</div>

<div class="container-fluid px-4">

    <div class="filter-card">
        <form asp-action="ListOrder" method="get" class="row g-3 align-items-center">
            <div class="col-md-5">
                <div class="search-box-wrapper">
                    <i class="fa-solid fa-magnifying-glass text-secondary"></i>
                    <input type="text" name="searchTerm" placeholder="Tìm tên khách hoặc SĐT..." value="@currentSearch" />
                </div>
            </div>
            <div class="col-md-4">
                <div class="search-box-wrapper">
                    <i class="fa-solid fa-filter text-secondary"></i>
                    <select name="status">
                        <option value="all" selected="@(currentStatus == "all")">Tất cả Trạng thái</option>
                        <option value="Confirmed" selected="@(currentStatus == "Confirmed")">Chờ khách (Confirmed)</option>
                        <option value="Guest Seated" selected="@(currentStatus == "Guest Seated")">Đang ngồi (Guest Seated)</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3 text-end">
                <button type="submit" class="btn-pos-primary w-100">
                    <i class="fas fa-search me-2"></i> Lọc dữ liệu
                </button>
            </div>
        </form>
    </div>

    <div class="table-card">
        <div class="table-responsive">
            <table class="table custom-table">
                <thead>
                    <tr>
                        <th>Khách hàng</th>
                        <th>Số điện thoại</th>
                        <th>Khu vực</th>
                        <th>Bàn</th>
                        <th>Giờ đặt</th>
                        <th>Ca (Slot)</th>
                        <th>Trạng thái</th>
                        <th class="text-center">Check in</th>
                    </tr>
                </thead>
                <tbody id="reservationTableBody">
                    @if (!Model.Reservations.Any())
                    {
                        <tr>
                            <td colspan="8" class="text-center py-5 text-muted">
                                <i class="fa-solid fa-inbox fs-1 mb-3 opacity-25"></i>
                                <p>Không tìm thấy đơn đặt bàn nào.</p>
                            </td>
                        </tr>
                    }
                    @foreach (var res in Model.Reservations)
                    {
                        <tr data-id="@res.ReservationId" id="res-row-@res.ReservationId">
                            <td>
                                <div class="fw-bold">@res.CustomerName</div>
                            </td>
                            <td>@res.CustomerPhone</td>
                            <td>@res.Areas</td>
                            <td>
                                <span class="badge bg-light text-dark border">@res.Tables</span>
                            </td>
                            <td>
                                <i class="fa-regular fa-clock text-muted me-1"></i>
                                @res.ReservationTime.ToString(@"hh\:mm")
                            </td>
                            <td>@res.TimeSlot</td>
                            <td class="status-cell">
                                @Html.Raw(GetStatusBadge(res.Status))
                            </td>
                            <td class="text-center">
                                <button class="btn-detail-view btn-open-modal mx-auto" data-id="@res.ReservationId" title="Xem chi tiết">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="pagination-container">
            <div class="text-muted small">
                Hiển thị <strong>@((Model.Pagination.PageNumber - 1) * Model.Pagination.PageSize + 1)</strong>
                - <strong>@Math.Min((Model.Pagination.PageNumber * Model.Pagination.PageSize), Model.Pagination.TotalCount)</strong>
                của <strong>@Model.Pagination.TotalCount</strong> đơn
            </div>
            <div class="d-flex">
                @if (Model.Pagination.HasPreviousPage)
                {
                    <a asp-action="ListOrder" asp-route-searchTerm="@currentSearch" asp-route-status="@currentStatus" asp-route-page="@(currentPage - 1)" class="page-btn">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                }
                else
                {
                    <span class="page-btn disabled"><i class="fas fa-chevron-left"></i></span>
                }

                <span class="page-btn" style="background: var(--primary-orange); color: white; border-color: var(--primary-orange);">@currentPage</span>

                @if (Model.Pagination.HasNextPage)
                {
                    <a asp-action="ListOrder" asp-route-searchTerm="@currentSearch" asp-route-status="@currentStatus" asp-route-page="@(currentPage + 1)" class="page-btn">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                }
                else
                {
                    <span class="page-btn disabled"><i class="fas fa-chevron-right"></i></span>
                }
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="detailModal">
    <div class="modal-popup">

        <div class="modal-header-custom">
            <h2><i class="fa-solid fa-clipboard-list me-2"></i>Chi tiết Đặt bàn</h2>
            <i class="fas fa-times modal-close" id="closeModal"></i>
        </div>

        <div class="modal-body-custom">
            <div class="detail-section">
                <h3>Thông tin Khách hàng</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <strong>Họ và tên</strong>
                        <span id="modalCustomerName">...</span>
                    </div>
                    <div class="detail-item">
                        <strong>Số điện thoại</strong>
                        <span id="modalCustomerPhone">...</span>
                    </div>
                    <div class="detail-item full-width">
                        <strong>Email</strong>
                        <span id="modalCustomerEmail">...</span>
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <h3>Thông tin Đặt chỗ</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <strong>Ngày đặt</strong>
                        <span id="modalReservationDate">...</span>
                    </div>
                    <div class="detail-item">
                        <strong>Giờ đến</strong>
                        <span id="modalReservationTime" class="text-danger">...</span>
                    </div>
                    <div class="detail-item">
                        <strong>Ca (Slot)</strong>
                        <span id="modalTimeSlot">...</span>
                    </div>
                    <div class="detail-item">
                        <strong>Số lượng khách</strong>
                        <span id="modalGuestCount">...</span>
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <h3>Vị trí bàn</h3>
                <div id="modalTableInfo" class="row g-2">
                </div>
            </div>

            <div class="detail-section border-bottom-0">
                <h3>Ghi chú</h3>
                <div class="p-3 bg-light rounded text-muted fst-italic" id="modalNotes">
                    Không có ghi chú
                </div>
            </div>
        </div>

        <div class="modal-footer-custom">
            <input type="hidden" id="modalReservationId" />
            <button class="btn btn-light border" id="closeModalFooter">Đóng</button>
            <button class="btn-pos-primary" id="btnSeatGuest">
                <i class="fas fa-user-check me-2"></i> Xác nhận Khách ngồi
            </button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function() {

        // === CẤU HÌNH ===
        const apiBaseUrl = "https://localhost:7096/api/DashboardTable";
        const signalRHubUrl = "https://localhost:7096/reservationHub";
        const modal = $('#detailModal');
        const tableBody = $('#reservationTableBody');

        // === HÀM UI: Modal Animation ===
        function showModalUI() {
            modal.css('display', 'flex');
            setTimeout(() => modal.addClass('show'), 10); // Trigger animation
        }

        function hideModalUI() {
            modal.removeClass('show');
            setTimeout(() => modal.css('display', 'none'), 300); // Wait for animation
        }

        // === LOGIC DATA ===
        function openDetailModal(id) {
            // Hiển thị trạng thái loading tạm thời (tùy chọn)
            $('#modalCustomerName').text('Đang tải...');

            $.get(`${apiBaseUrl}/${id}`, function(data) {
                // 1. Thông tin khách
                $('#modalCustomerName').text(data.customerName || 'N/A');
                $('#modalCustomerPhone').text(data.customerPhone || 'N/A');
                $('#modalCustomerEmail').text(data.customerEmail || 'N/A');

                // 2. Thông tin đặt
                $('#modalReservationDate').text(new Date(data.reservationDate).toLocaleDateString('vi-VN'));
                $('#modalReservationTime').text(formatTimeSpan(data.reservationTime));
                $('#modalTimeSlot').text(data.timeSlot || 'N/A');
                $('#modalGuestCount').text(data.numberOfGuests + ' người');

                // 3. Thông tin bàn
                const tableInfoDiv = $('#modalTableInfo').empty();
                if (data.assignedTables && data.assignedTables.length > 0) {
                    data.assignedTables.forEach(table => {
                        const tableHtml = `
                            <div class="col-12">
                                <div class="d-flex align-items-center p-2 border rounded bg-white">
                                    <div class="bg-light rounded-circle p-2 me-3 text-secondary">
                                        <i class="fas fa-chair"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold text-dark">Bàn ${escapeHtml(table.tableNumber)}</div>
                                        <div class="small text-muted">${escapeHtml(table.position)} - Tầng ${table.floor}</div>
                                    </div>
                                </div>
                            </div>`;
                        tableInfoDiv.append(tableHtml);
                    });
                } else {
                    tableInfoDiv.html('<div class="col-12 text-danger p-2"><i class="fa-solid fa-circle-exclamation me-1"></i> Chưa gán bàn!</div>');
                }

                // 4. Ghi chú
                $('#modalNotes').text(data.notes || 'Không có ghi chú');

                // 5. Nút hành động
                $('#modalReservationId').val(data.reservationId);
                if (data.status === 'Confirmed') {
                    $('#btnSeatGuest').show();
                } else {
                    $('#btnSeatGuest').hide();
                }

                showModalUI(); // Gọi hàm hiển thị đẹp

            }).fail(function() {
                alert('Không thể tải chi tiết đặt bàn.');
            });
        }

        function seatGuest() {
            const id = $('#modalReservationId').val();
            if (!id) return;

            $('#btnSeatGuest').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xử lý...');

            $.ajax({
                url: `${apiBaseUrl}/${id}/seat`,
                method: 'PUT',
                success: function() {
                    hideModalUI();
                    location.reload();
                },
                error: function(err) {
                    alert('Lỗi: ' + (err.responseJSON?.message || 'Không thể cập nhật trạng thái.'));
                },
                complete: function() {
                    $('#btnSeatGuest').prop('disabled', false).html('<i class="fas fa-user-check me-2"></i> Xác nhận Khách ngồi');
                }
            });
        }

        // === UTILS ===
        function getStatusBadge(status) {
            const statusMap = {
                'Confirmed': '<span class="status-badge status-confirmed">Chờ khách</span>',
                'Guest Seated': '<span class="status-badge status-guest-seated">Đang ngồi</span>',
            };
            return statusMap[status] || `<span class="status-badge bg-light border">${status}</span>`;
        }

        function formatTimeSpan(timeSpan) {
            if (typeof timeSpan === 'string') return timeSpan.substring(0, 5);
            if (typeof timeSpan === 'object') return `${String(timeSpan.hours).padStart(2, '0')}:${String(timeSpan.minutes).padStart(2, '0')}`;
            return 'N/A';
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // === EVENTS ===
        tableBody.on('click', '.btn-open-modal', function() {
            openDetailModal($(this).data('id'));
        });

        $('#closeModal, #closeModalFooter').on('click', function() {
            hideModalUI();
        });

        // Đóng khi click ra ngoài modal
        $(window).on('click', function(e) {
             if ($(e.target).is('#detailModal')) {
                hideModalUI();
            }
        });

        $('#btnSeatGuest').on('click', seatGuest);

        // === SIGNALR ===
        const connection = new signalR.HubConnectionBuilder().withUrl(signalRHubUrl).build();
        connection.on("ReservationStatusChanged", function (data) {
            const row = $(`#res-row-${data.reservationId}`);
            if (row.length) {
                row.find('.status-cell').html(getStatusBadge(data.newStatus));
                // Thêm hiệu ứng nháy sáng để báo hiệu thay đổi
                row.css('background-color', '#fff3cd').animate({ backgroundColor: '#ffffff' }, 1000);
            }
        });
        connection.start().catch(err => console.error(err.toString()));
    });
</script>

@functions {
    public static string GetStatusBadge(string status)
    {
        return status switch
        {
            "Confirmed" => "<span class=\"status-badge status-confirmed\">Chờ khách</span>",
            "Guest Seated" => "<span class=\"status-badge status-guest-seated\">Đang ngồi</span>",
            _ => $"<span class=\"status-badge bg-light border\">{status}</span>"
        };
    }
}