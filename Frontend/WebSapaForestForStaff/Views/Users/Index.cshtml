@model WebSapaForestForStaff.DTOs.UserManagement.UserListResponse

@{
    ViewData["Title"] = "Quản lý người dùng";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="container-fluid">
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">Quản lý người dùng</h1>
            <p class="page-subtitle">Quản lý tài khoản nhân viên và phân quyền hệ thống</p>
        </div>
        <div class="page-actions">
            @if (User.IsInRole("Admin") || User.IsInRole("Owner"))
            {
                <a asp-action="Create" class="btn btn-primary">
                    <i class="bi bi-person-plus"></i> Tạo người dùng mới
                </a>
            }
            @if (User.IsInRole("Admin") || User.IsInRole("Owner"))
            {
                <a asp-action="CreateManager" class="btn btn-success">
                    <i class="bi bi-person-badge"></i> Tạo quản lý
                </a>
            }
            @if (User.IsInRole("Manager") || User.IsInRole("Admin") || User.IsInRole("Owner"))
            {
                <a asp-action="CreateStaff" class="btn btn-info">
                    <i class="bi bi-people"></i> Tạo nhân viên
                </a>
            }
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["WarningMessage"] != null)
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @TempData["WarningMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Search and Filter Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="bi bi-search"></i> Tìm kiếm và lọc
            </h5>
        </div>
        <div class="card-body">
            <form method="get" asp-action="Index" class="row g-3">
                <div class="col-md-4">
                    <label for="searchTerm" class="form-label">Tìm kiếm</label>
                    <input type="text" class="form-control" id="searchTerm" name="searchTerm" 
                           placeholder="Tên, email, số điện thoại..." value="@ViewBag.SearchTerm">
                </div>
              @*   <div class="col-md-3">
                    <label for="roleId" class="form-label">Vai trò</label>
                    <select class="form-select" id="roleId" name="roleId">
                        <option value="">Tất cả vai trò</option>
                        <option value="1" @(ViewBag.RoleId == 1 ? "selected" : "")>Owner</option>
                        <option value="2" @(ViewBag.RoleId == 2 ? "selected" : "")>Admin</option>
                        <option value="3" @(ViewBag.RoleId == 3 ? "selected" : "")>Manager</option>
                        <option value="4" @(ViewBag.RoleId == 4 ? "selected" : "")>Staff</option>
                        <option value="5" @(ViewBag.RoleId == 5 ? "selected" : "")>Customer</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label">Trạng thái</label>
                    <select class="form-select" id="status" name="status">
                        <option value="">Tất cả trạng thái</option>
                        <option value="0" @(ViewBag.Status == 0 ? "selected" : "")>Hoạt động</option>
                        <option value="1" @(ViewBag.Status == 1 ? "selected" : "")>Không hoạt động</option>
                        <option value="2" @(ViewBag.Status == 2 ? "selected" : "")>Khóa</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="pageSize" class="form-label">Số lượng/trang</label>
                    <select class="form-select" id="pageSize" name="pageSize">
                        <option value="10" @(ViewBag.PageSize == 10 ? "selected" : "")>10</option>
                        <option value="25" @(ViewBag.PageSize == 25 ? "selected" : "")>25</option>
                        <option value="50" @(ViewBag.PageSize == 50 ? "selected" : "")>50</option>
                        <option value="100" @(ViewBag.PageSize == 100 ? "selected" : "")>100</option>
                    </select>
                </div> *@
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Tìm kiếm
                    </button>
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="bi bi-arrow-clockwise"></i> Làm mới
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Users Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="bi bi-people"></i> Danh sách người dùng
                <span class="badge bg-primary ms-2">@Model.TotalCount</span>
            </h5>
            <div class="bulk-actions">
                <button type="button" class="btn btn-warning btn-sm" onclick="bulkChangeStatus(0)">
                    <i class="bi bi-check-circle"></i> Kích hoạt hàng loạt
                </button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="bulkChangeStatus(1)">
                    <i class="bi bi-pause-circle"></i> Vô hiệu hóa hàng loạt
                </button>
                <button type="button" class="btn btn-danger btn-sm" onclick="bulkDelete()">
                    <i class="bi bi-trash"></i> Xóa hàng loạt
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="50">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th>ID</th>
                            <th>Họ tên</th>
                            <th>Email</th>
                            <th>Số điện thoại</th>
                            <th>Vai trò</th>
                            <th>Trạng thái</th>
                            <th>Ngày tạo</th>
                            <th width="200">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in Model.Users)
                        {
                            <tr>
                                <td>
                                    <input type="checkbox" class="user-checkbox" value="@user.UserId">
                                </td>
                                <td>@user.UserId</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                            @user.FullName.Substring(0, 1).ToUpper()
                                        </div>
                                        <div>
                                            <div class="fw-semibold">@user.FullName</div>
                                        </div>
                                    </div>
                                </td>
                                <td>@user.Email</td>
                                <td>@(user.Phone ?? "N/A")</td>
                                <td>
                                    <span class="badge role-badge role-@user.RoleName?.ToLower()">
                                        @(user.RoleName ?? "N/A")
                                    </span>
                                </td>
                                <td>
                                    <span class="badge status-badge status-@user.Status">
                                        @(user.Status == 0 ? "Hoạt động" : user.Status == 1 ? "Không hoạt động" : "Khóa")
                                    </span>
                                </td>
                                <td>@(user.CreatedAt?.ToString("dd/MM/yyyy") ?? "N/A")</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a asp-action="Details" asp-route-id="@user.UserId" 
                                           class="btn btn-info btn-sm" title="Chi tiết">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a asp-action="Edit" asp-route-id="@user.UserId" 
                                           class="btn btn-warning btn-sm" title="Sửa">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        @if (User.IsInRole("Admin") || User.IsInRole("Owner"))
                                        {
                                            <a asp-action="ResetPassword" asp-route-id="@user.UserId" 
                                               class="btn btn-secondary btn-sm" title="Đặt lại mật khẩu">
                                                <i class="bi bi-key"></i>
                                            </a>
                                        }
                                        @if (user.Status == 0)
                                        {
                                            <form asp-action="ChangeStatus" method="post" style="display: inline;">
                                                <input type="hidden" name="id" value="@user.UserId" />
                                                <input type="hidden" name="status" value="1" />
                                                <button type="submit" class="btn btn-secondary btn-sm" 
                                                        onclick="return confirm('Bạn có chắc muốn vô hiệu hóa người dùng này?')" title="Vô hiệu hóa">
                                                    <i class="bi bi-pause"></i>
                                                </button>
                                            </form>
                                        }
                                        else
                                        {
                                            <form asp-action="ChangeStatus" method="post" style="display: inline;">
                                                <input type="hidden" name="id" value="@user.UserId" />
                                                <input type="hidden" name="status" value="0" />
                                                <button type="submit" class="btn btn-success btn-sm" title="Kích hoạt">
                                                    <i class="bi bi-play"></i>
                                                </button>
                                            </form>
                                        }
                                        <form asp-action="Delete" method="post" style="display: inline;">
                                            <input type="hidden" name="id" value="@user.UserId" />
                                            <button type="submit" class="btn btn-danger btn-sm" 
                                                    onclick="return confirm('Bạn có chắc muốn xóa người dùng này?')" title="Xóa">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    @if (Model.TotalPages > 1)
    {
        <nav aria-label="User pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item @(Model.HasPreviousPage ? "" : "disabled")">
                    <a class="page-link" href="?page=@(Model.Page - 1)&pageSize=@Model.PageSize">Trước</a>
                </li>
                
                @for (int i = Math.Max(1, Model.Page - 2); i <= Math.Min(Model.TotalPages, Model.Page + 2); i++)
                {
                    <li class="page-item @(i == Model.Page ? "active" : "")">
                        <a class="page-link" href="?page=@i&pageSize=@Model.PageSize">@i</a>
                    </li>
                }
                
                <li class="page-item @(Model.HasNextPage ? "" : "disabled")">
                    <a class="page-link" href="?page=@(Model.Page + 1)&pageSize=@Model.PageSize">Sau</a>
                </li>
            </ul>
        </nav>
    }
</div>

<!-- Bulk Actions Form -->
<form id="bulkForm" asp-action="BulkDelete" method="post" style="display: none;">
    <input type="hidden" name="userIds" id="bulkUserIds" />
</form>

<form id="bulkStatusForm" asp-action="BulkChangeStatus" method="post" style="display: none;">
    <input type="hidden" name="userIds" id="bulkStatusUserIds" />
    <input type="hidden" name="status" id="bulkStatus" />
</form>

<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #dee2e6;
    }

    .header-content .page-title {
        margin: 0;
        color: #2f2f2f;
        font-weight: 600;
    }

    .header-content .page-subtitle {
        margin: 0.5rem 0 0 0;
        color: #6c757d;
        font-size: 0.9rem;
    }

    .page-actions {
        display: flex;
        gap: 0.5rem;
    }

    .avatar-sm {
        width: 32px;
        height: 32px;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .role-badge {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .role-owner { background-color: #6f42c1; color: white; }
    .role-admin { background-color: #dc3545; color: white; }
    .role-manager { background-color: #ffc107; color: #212529; }
    .role-staff { background-color: #17a2b8; color: white; }
    .role-customer { background-color: #28a745; color: white; }

    .status-badge {
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-0 { background-color: #d4edda; color: #155724; }
    .status-1 { background-color: #f8d7da; color: #721c24; }
    .status-2 { background-color: #fff3cd; color: #856404; }

    .bulk-actions {
        display: flex;
        gap: 0.5rem;
    }

    .table th {
        font-weight: 600;
        color: #495057;
        border-top: none;
    }

    .btn-group .btn {
        margin-right: 2px;
    }

    .btn-group .btn:last-child {
        margin-right: 0;
    }
</style>

<script>
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.user-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
    }

    function bulkDelete() {
        const selectedIds = getSelectedUserIds();
        if (selectedIds.length === 0) {
            alert('Vui lòng chọn ít nhất một người dùng để xóa');
            return;
        }

        if (confirm(`Bạn có chắc muốn xóa ${selectedIds.length} người dùng đã chọn?`)) {
            document.getElementById('bulkUserIds').value = selectedIds.join(',');
            document.getElementById('bulkForm').submit();
        }
    }

    function bulkChangeStatus(status) {
        const selectedIds = getSelectedUserIds();
        if (selectedIds.length === 0) {
            alert('Vui lòng chọn ít nhất một người dùng để thay đổi trạng thái');
            return;
        }

        const statusText = status === 0 ? 'kích hoạt' : 'vô hiệu hóa';
        if (confirm(`Bạn có chắc muốn ${statusText} ${selectedIds.length} người dùng đã chọn?`)) {
            document.getElementById('bulkStatusUserIds').value = selectedIds.join(',');
            document.getElementById('bulkStatus').value = status;
            document.getElementById('bulkStatusForm').submit();
        }
    }

    function getSelectedUserIds() {
        const checkboxes = document.querySelectorAll('.user-checkbox:checked');
        return Array.from(checkboxes).map(cb => cb.value);
    }
</script>
