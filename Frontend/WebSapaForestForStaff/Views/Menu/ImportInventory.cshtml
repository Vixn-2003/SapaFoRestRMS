@using Newtonsoft.Json
@model BusinessAccessLayer.DTOs.Inventory.ImportIngredient
@{
    ViewData["Title"] = "Nhập Hàng Vào Kho";
    Layout = "_LayoutInventory";
}

<title>Nhập Hàng Vào Kho</title>
<style>
    /* ===== CSS GỐC CỦA INVENTORY PAGE ===== */
    .inventory-page * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f3f4f6;
    }

    .inventory-page .ip-wrapper {
        max-width: 1600px;
        margin: 0 auto;
    }

    .inventory-page .ip-header {
        background: white;
        padding: 20px 30px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .inventory-page .ip-header h1 {
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 5px;
        color: #1f2937;
    }

    .inventory-page .ip-header p {
        color: #6b7280;
        font-size: 14px;
    }

    /* TOAST NOTIFICATION */
    .inventory-page .ip-toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .inventory-page .ip-toast {
        background: white;
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 300px;
        max-width: 400px;
        animation: slideIn 0.3s ease-out;
    }

    @@keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .inventory-page .ip-toast.slideOut {
        animation: slideOut 0.3s ease-out forwards;
    }

    @@keyframes slideOut {
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }

    .ip-toast-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
    }

    .ip-toast.error .ip-toast-icon {
        background: #fee2e2;
        color: #dc2626;
    }

    .ip-toast.success .ip-toast-icon {
        background: #d1fae5;
        color: #059669;
    }

    .ip-toast.warning .ip-toast-icon {
        background: #fef3c7;
        color: #d97706;
    }

    .ip-toast-content {
        flex: 1;
    }

    .ip-toast-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 2px;
        color: #1f2937;
    }

    .ip-toast-message {
        font-size: 13px;
        color: #6b7280;
    }

    .ip-toast-close {
        background: transparent;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        font-size: 20px;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .ip-toast-close:hover {
        background: #f3f4f6;
        color: #374151;
    }

    .inventory-page .ip-main-container {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 20px;
    }

    .inventory-page .ip-main-form {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .ip-section-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 20px;
        color: #10b981;
    }

    .ip-form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .ip-form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .ip-form-group label {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
    }

    .ip-form-group label.ip-required::after {
        content: ' *';
        color: #ef4444;
    }

    .ip-form-group input,
    .ip-form-group select {
        padding: 12px 15px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        background: #2c3e50;
        color: white;
        font-family: inherit;
    }

    .ip-form-group input:focus,
    .ip-form-group select:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .ip-form-group input[readonly] {
        background: #374151;
        cursor: not-allowed;
    }

    /* SUPPLIER BUTTON STYLE */
    .ip-supplier-btn {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        background: #2c3e50;
        color: white;
        text-align: left;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-family: inherit;
    }

    .ip-supplier-btn:hover {
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .ip-supplier-btn:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .ip-supplier-btn-text {
        flex: 1;
    }

    .ip-supplier-btn-icon {
        font-size: 14px;
        opacity: 0.7;
    }

    .ip-status-badge {
        display: inline-block;
        padding: 8px 16px;
        background: #f59e0b;
        color: white;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
    }

    .ip-supplier-detail {
        background: #2c3e50;
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 25px;
        display: none;
    }

    .ip-supplier-detail h3 {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 15px;
    }

    .ip-supplier-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        font-size: 13px;
    }

    .ip-supplier-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .ip-supplier-label {
        color: #94a3b8;
        font-size: 12px;
    }

    .ip-supplier-value {
        font-weight: 500;
    }

    .ip-btn-add {
        background: #10b981;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: background 0.2s;
    }

    .ip-btn-add:hover {
        background: #059669;
    }

    .ip-materials-table {
        width: 100%;
        border-collapse: collapse;
        background: #f9fafb;
        border-radius: 8px;
        overflow: hidden;
        margin: 20px 0;
    }

    .ip-materials-table thead {
        background: #2c3e50;
        color: white;
    }

    .ip-materials-table th {
        padding: 12px;
        text-align: left;
        font-size: 12px;
        font-weight: 600;
    }

    .ip-materials-table td {
        padding: 12px;
        background: #2c3e50;
        color: white;
        border-bottom: 2px solid #1e293b;
        font-size: 13px;
    }

    .ip-quantity-input {
        width: 80px;
        padding: 6px 8px;
        border: 1px solid #475569;
        border-radius: 4px;
        background: #1e293b;
        color: white;
        font-size: 13px;
        text-align: center;
    }

    .ip-quantity-input:focus {
        outline: none;
        border-color: #10b981;
    }

    .ip-btn-remove {
        background: #ef4444;
        color: white;
        border: none;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .ip-btn-remove:hover {
        background: #dc2626;
    }

    .ip-total-section {
        background: #2c3e50;
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: right;
        margin-bottom: 25px;
    }

    .ip-total-label {
        font-size: 14px;
        margin-bottom: 8px;
    }

    .ip-total-amount {
        font-size: 32px;
        font-weight: 700;
        color: #10b981;
    }

    .ip-action-buttons {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
    }

    .ip-btn-action {
        padding: 14px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s;
    }

    .ip-btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .ip-btn-back {
        background: #6b7280;
        color: white;
    }

    .ip-btn-save {
        background: #3b82f6;
        color: white;
    }

    .ip-btn-confirm {
        background: #10b981;
        color: white;
    }

    .ip-btn-delete {
        background: #ef4444;
        color: white;
    }

    /* MODAL NGUYÊN LIỆU */
    .ip-modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 16px;
    }

    .ip-modal-overlay.active {
        display: flex;
    }

    .ip-modal-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 1200px;
        max-height: 600px;
        display: flex;
        overflow: hidden;
    }

    .ip-modal-left {
        width: 50%;
        border-right: 1px solid #e5e7eb;
        overflow-y: auto;
        background: #f9fafb;
    }

    .ip-modal-left-header {
        padding: 24px;
        position: sticky;
        top: 0;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
        z-index: 10;
    }

    .ip-modal-left-header h3 {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 16px;
    }

    .ip-modal-search {
        width: 100%;
        padding: 10px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
    }

    .ip-modal-search:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .ip-modal-materials-list {
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .ip-material-item {
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
    }

    .ip-material-item:hover {
        border-color: #10b981;
        background: #f0fdf4;
    }

    .ip-material-item.selected {
        border-color: #10b981;
        background: #d1fae5;
    }

    .ip-material-item-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
    }

    .ip-material-item-name {
        font-weight: 600;
        font-size: 14px;
        color: #1f2937;
    }

    .ip-material-item-code {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
    }

    .ip-material-item-unit {
        font-size: 12px;
        background: #e5e7eb;
        color: #374151;
        padding: 4px 8px;
        border-radius: 4px;
    }

    .ip-modal-right {
        width: 50%;
        padding: 24px;
        position: relative;
        overflow-y: auto;
    }

    .ip-modal-close {
        position: absolute;
        top: 16px;
        right: 16px;
        background: transparent;
        border: none;
        color: #6b7280;
        cursor: pointer;
        font-size: 24px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .ip-modal-close:hover {
        background: #f3f4f6;
        color: #1f2937;
    }

    .ip-modal-right h3 {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 16px;
    }

    .ip-btn-new-material {
        background: #10b981;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
        transition: background 0.2s;
    }

    .ip-btn-new-material:hover {
        background: #059669;
    }

    .ip-btn-back-select {
        background: transparent;
        border: none;
        color: #6b7280;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        text-decoration: underline;
        margin-bottom: 16px;
    }

    .ip-btn-back-select:hover {
        color: #1f2937;
    }

    .ip-modal-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .ip-modal-form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .ip-modal-form-group label {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
    }

    .ip-modal-form-group label.required::after {
        content: ' *';
        color: #ef4444;
    }

    .ip-modal-form-group input {
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
    }

    .ip-modal-form-group input:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .ip-modal-form-group input:disabled {
        background: #f3f4f6;
        cursor: not-allowed;
        color: #9ca3af;
    }

    .ip-modal-form-group input[readonly] {
        background: #f3f4f6;
        cursor: not-allowed;
        color: #6b7280;
    }

    .ip-form-hint {
        font-size: 12px;
        color: #6b7280;
    }

    .ip-modal-total-preview {
        background: #dbeafe;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #93c5fd;
        display: none;
    }

    .ip-modal-total-preview p {
        font-size: 14px;
        color: #1e40af;
        margin: 0;
    }

    .ip-modal-total-preview span {
        font-weight: 600;
        color: #1e3a8a;
    }

    .ip-modal-actions {
        display: flex;
        gap: 12px;
        padding-top: 16px;
    }

    .ip-modal-actions button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s;
    }

    .ip-modal-btn-add {
        background: #10b981;
        color: white;
    }

    .ip-modal-btn-add:hover:not(:disabled) {
        background: #059669;
    }

    .ip-modal-btn-add:disabled {
        background: #d1d5db;
        cursor: not-allowed;
    }

    .ip-modal-btn-cancel {
        background: #e5e7eb;
        color: #374151;
    }

    .ip-modal-btn-cancel:hover {
        background: #d1d5db;
    }

    .ip-empty-message {
        text-align: center;
        color: #6b7280;
        padding: 32px 16px;
        font-size: 14px;
    }

    .ip-empty-state {
        text-align: center;
        color: #6b7280;
        padding: 40px 16px;
        font-size: 14px;
    }

    .ip-sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .ip-sidebar-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .ip-sidebar-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #1f2937;
    }

    .ip-supplier-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .ip-supplier-card {
        display: flex;
        padding: 12px;
        background: #2c3e50;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        transition: all 0.2s;
        align-items: center;
        gap: 12px;
    }

    .ip-supplier-card:hover {
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .ip-supplier-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
        flex-shrink: 0;
        background: #3b82f6;
    }

    .ip-supplier-info {
        flex: 1;
    }

    .ip-supplier-name {
        font-weight: 600;
        font-size: 13px;
        margin-bottom: 3px;
    }

    .ip-supplier-count {
        font-size: 11px;
        opacity: 0.8;
    }

    .ip-supplier-total {
        font-size: 14px;
        font-weight: 700;
        color: #10b981;
    }

    /* ===== CSS MỚI CHO POPUP NHÀ CUNG CẤP ===== */
    
    .supplier-popup-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 3000;
        align-items: center;
        justify-content: center;
        padding: 16px;
    }

    .supplier-popup-overlay.sp-active {
        display: flex;
    }

    .supplier-popup-container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        width: 100%;
        max-width: 1400px;
        max-height: 85vh;
        display: flex;
        overflow: hidden;
        animation: spSlideUp 0.3s ease-out;
    }

    @@keyframes spSlideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .supplier-popup-header {
        padding: 24px 32px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f9fafb;
    }

    .supplier-popup-header h2 {
        font-size: 24px;
        font-weight: 700;
        color: #1f2937;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .supplier-popup-close {
        background: transparent;
        border: none;
        color: #6b7280;
        cursor: pointer;
        font-size: 28px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .supplier-popup-close:hover {
        background: #f3f4f6;
        color: #1f2937;
    }

    .supplier-popup-left {
        width: 1000%;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        background: #f9fafb;
    }

    .supplier-popup-search-section {
        padding: 24px;
        border-bottom: 1px solid #e5e7eb;
        background: white;
    }

    .sp-search-group {
        margin-bottom: 16px;
    }

    .sp-search-group:last-child {
        margin-bottom: 0;
    }

    .sp-search-label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
    }

    .sp-search-input-wrapper {
        position: relative;
    }

    .sp-search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        pointer-events: none;
    }

    .sp-search-input {
        width: 100%;
        padding: 10px 12px 10px 40px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s;
    }

    .sp-search-input:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .sp-search-hint {
        font-size: 11px;
        color: #6b7280;
        margin-top: 4px;
    }

    .supplier-popup-list {
        max-height: 500px;
        overflow-y: auto;
        padding-right: 5px;
    }

    .sp-list-empty {
        text-align: center;
        color: #6b7280;
        padding: 40px 0;
        font-style: italic;
    }

    .sp-supplier-card {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 14px 16px;
        margin-bottom: 10px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .sp-supplier-card:hover {
            border-color: #2563eb;
            box-shadow: 0 3px 8px rgba(37,99,235,0.15);
            transform: translateY(-2px);
            background: #f9fafb;
    }

    .sp-supplier-card.sp-selected {
            border-color: #2563eb;
            background: #eff6ff;
            box-shadow: 0 3px 8px rgba(37,99,235,0.2);
    }

    .sp-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px dashed #e5e7eb;
        padding-bottom: 6px;
    }

    .sp-card-title {
        flex: 1;
    }

    .sp-card-name {
        font-weight: 600;
        font-size: 16px;
        color: #111827;
    }

    .sp-card-phone {
        font-size: 14px;
        color: #2563eb;
        font-weight: 500;
    }

    .sp-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        white-space: nowrap;
    }

    .sp-status-badge.sp-active {
        background: #d1fae5;
        color: #059669;
    }

    .sp-status-badge.sp-restricted {
        background: #fee2e2;
        color: #dc2626;
    }

    .sp-card-materials {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .sp-material-tag {
        padding: 4px 8px;
        background: #f3f4f6;
        color: #4b5563;
        border-radius: 4px;
        font-size: 11px;
    }

    .sp-material-tag.sp-highlight {
        background: #fef3c7;
        color: #d97706;
        font-weight: 600;
    }

    .sp-material-count {
        background: #dbeafe;
        color: #1e40af;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        margin-left: auto;
    }


    .supplier-popup-details {
        flex: 1;
        overflow-y: auto;
        padding: 32px;
    }

    .sp-details-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #9ca3af;
        text-align: center;
    }

    .sp-details-empty-icon {
        width: 80px;
        height: 80px;
        margin-bottom: 16px;
        opacity: 0.3;
    }

    .sp-details-title {
        font-size: 20px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 24px;
    }

    .sp-detail-section {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
    }

    .sp-detail-row {
        display: flex;
        align-items: start;
        gap: 12px;
        margin-bottom: 16px;
    }

    .sp-detail-row:last-child {
        margin-bottom: 0;
    }

    .sp-detail-icon {
        width: 20px;
        height: 20px;
        color: #10b981;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .sp-detail-content {
        flex: 1;
    }

    .sp-detail-label {
        font-size: 12px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .sp-detail-value {
        font-size: 14px;
        color: #1f2937;
        font-weight: 500;
    }

    .sp-materials-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-top: 8px;
    }

    .sp-material-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
    }

    .sp-material-name {
        font-size: 13px;
        color: #374151;
        font-weight: 500;
    }

    .sp-material-qty {
        font-size: 12px;
        color: #6b7280;
        background: #f3f4f6;
        padding: 2px 8px;
        border-radius: 4px;
    }

    .supplier-popup-actions {
        padding: 20px 32px;
        border-top: 1px solid #e5e7eb;
        background: #f9fafb;
    }

    .sp-btn-confirm {
        width: 100%;
        padding: 14px 24px;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .sp-btn-confirm:hover:not(:disabled) {
        background: #059669;
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
    }

    .sp-btn-confirm:disabled {
        background: #d1d5db;
        cursor: not-allowed;
        transform: none;
    }

    .sp-warning-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 4000;
        align-items: center;
        justify-content: center;
        padding: 16px;
    }

    .sp-warning-overlay.sp-active {
        display: flex;
    }

    .sp-warning-dialog {
        background: white;
        border-radius: 16px;
        max-width: 480px;
        width: 100%;
        padding: 24px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        animation: spSlideUp 0.3s ease-out;
    }

    .sp-warning-header {
        display: flex;
        align-items: start;
        gap: 16px;
        margin-bottom: 20px;
    }

    .sp-warning-icon {
        width: 48px;
        height: 48px;
        background: #fee2e2;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .sp-warning-icon svg {
        width: 24px;
        height: 24px;
        color: #dc2626;
    }

    .sp-warning-content h3 {
        font-size: 18px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 8px;
    }

    .sp-warning-content p {
        font-size: 14px;
        color: #6b7280;
        line-height: 1.5;
    }

    .sp-warning-content strong {
        color: #1f2937;
    }

    .sp-warning-actions {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }

    .sp-warning-btn {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .sp-warning-btn-cancel {
        background: #f3f4f6;
        color: #374151;
    }

    .sp-warning-btn-cancel:hover {
        background: #e5e7eb;
    }

    .sp-warning-btn-confirm {
        background: #dc2626;
        color: white;
    }

    .sp-warning-btn-confirm:hover {
        background: #b91c1c;
    }

    .supplier-popup-list::-webkit-scrollbar,
    .supplier-popup-details::-webkit-scrollbar {
        width: 6px;
    }

    .supplier-popup-list::-webkit-scrollbar-track,
    .supplier-popup-details::-webkit-scrollbar-track {
        background: #f3f4f6;
    }

    .supplier-popup-list::-webkit-scrollbar-thumb,
    .supplier-popup-details::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }

    .supplier-popup-list::-webkit-scrollbar-thumb:hover,
    .supplier-popup-details::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
    }

    @@media (max-width: 1200px) {
        .ip-main-container {
            grid-template-columns: 1fr;
        }

        .ip-modal-container {
            flex-direction: column;
            max-height: 90vh;
        }

        .ip-modal-left,
        .ip-modal-right {
            width: 100%;
        }

        .supplier-popup-container {
            flex-direction: column;
            max-height: 90vh;
        }

        .supplier-popup-left{
            width: 100%;
            max-height: 50vh;
        }

        .supplier-popup-left {
            border-right: none;
            border-bottom: 1px solid #e5e7eb;
        }
    }

    @@media (max-width: 768px) {
        .ip-form-row {
            grid-template-columns: 1fr;
        }

        .ip-action-buttons {
            grid-template-columns: 1fr;
        }
    }

    .ip-supplier-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.ip-supplier-card {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
}

.ip-supplier-card:hover {
    background-color: #f0f8ff;
}

.ip-supplier-avatar {
    background: #007bff;
    color: #fff;
    font-weight: bold;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    text-align: center;
    line-height: 35px;
    display: inline-block;
    margin-right: 8px;
}


    .sp-search {
        margin-bottom: 10px;
    }

    #spSearchInput {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 15px;
    }

    .sp-supplier-card {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

        .sp-supplier-card:hover {
            border-color: #2563eb;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

    .sp-selected {
        border-color: #2563eb;
        background: #eff6ff;
    }

    .sp-card-name {
        font-weight: 600;
        font-size: 16px;
    }

    .sp-card-body {
        font-size: 14px;
        color: #374151;
        margin-top: 4px;
        line-height: 1.5;
    }

        .sp-card-body p {
            margin: 2px 0;
        }

        .sp-card-body strong {
            color: #111827;
            font-weight: 600;
            width: 90px;
            display: inline-block;
        }

    .ip-warehouse-select {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #475569;
        border-radius: 4px;
        background: #1e293b;
        color: white;
        font-size: 13px;
        cursor: pointer;
    }

        .ip-warehouse-select:focus {
            outline: none;
            border-color: #10b981;
        }

        .ip-warehouse-select option {
            background: #1e293b;
            color: white;
        }
</style>

<body>
    <div class="inventory-page">
        <div class="ip-toast-container" id="ipToastContainer"></div>

        <div class="ip-wrapper">
            <div class="ip-header">
                <h1>Nhập Hàng Vào Kho</h1>
                <p>Tạo đơn nhập hàng mới từ nhà cung cấp</p>
            </div>

            <div class="ip-main-container">
                <div class="ip-main-form">
                    <div class="ip-section-title">Thông tin chung</div>
                    
                    <div class="ip-form-row">
                        <div class="ip-form-group">
                            <label class="ip-required">Mã đơn nhập</label>
                            <input type="text" value="PO-2025-001" readonly>
                        </div>

                        <div class="ip-form-group">
                            <label class="ip-required">Nhà cung cấp</label>
                            <button type="button" class="ip-supplier-btn" id="ipSupplierBtn">
                                <span class="ip-supplier-btn-text" id="ipSupplierBtnText">-- Chọn nhà cung cấp --</span>
                                <span class="ip-supplier-btn-icon">▼</span>
                            </button>
                        </div>

                        <div class="ip-form-group">
                            <label class="ip-required">Ngày nhập</label>
                            <input type="datetime-local"
                                   value="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")"
                                   readonly
                                   style="background: #374151; cursor: not-allowed;" />
                        </div>

                        <div class="ip-form-group">
                            <label>Trạng thái</label>
                            <div style="padding-top: 12px;">
                                <span class="ip-status-badge">Chưa tạo đơn</span>
                            </div>
                        </div>
                    </div>

                    <div class="ip-supplier-detail" id="ipSupplierDetail">
                        <h3>Chi tiết nhà cung cấp</h3>
                        <div class="ip-supplier-grid">
                            <div class="ip-supplier-item">
                                <span class="ip-supplier-label">Tên nhà cung cấp</span>
                                <span class="ip-supplier-value" id="ipDetailName">-</span>
                            </div>
                            <div class="ip-supplier-item">
                                <span class="ip-supplier-label">Mã nhà cung cấp</span>
                                <span class="ip-supplier-value" id="ipDetailCode">-</span>
                            </div>

                            <div class="ip-supplier-item">
                                <span class="ip-supplier-label">Điện thoại</span>
                                <span class="ip-supplier-value" id="ipDetailPhone">-</span>
                            </div>
                            <div class="ip-supplier-item">
                                <span class="ip-supplier-label">Người liên hệ</span>
                                <span class="ip-supplier-value" id="ipDetailContact">-</span>
                            </div>
                            <div class="ip-supplier-item">
                                <span class="ip-supplier-label">Email</span>
                                <span class="ip-supplier-value" id="ipDetailEmail">-</span>
                            </div>
                            <div class="ip-supplier-item" style="grid-column: 1 / -1;">
                                <span class="ip-supplier-label">Địa chỉ</span>
                                <span class="ip-supplier-value" id="ipDetailAddress">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="ip-section-title">Chi tiết nguyên liệu nhập</div>
                    
                    <button class="ip-btn-add" id="ipBtnOpenModal">
                        <span>+</span>
                        <span>Thêm nguyên liệu</span>
                    </button>

                    <table class="ip-materials-table" id="ipMaterialsTable">
                        <thead>
                            <tr>
                                <th style="width: 50px;">STT</th>
                                <th style="width: 100px;">Mã NL</th>
                                <th>Tên nguyên liệu</th>
                                <th style="width: 150px;">Kho nhập</th>
                                <th style="width: 90px;">Số lượng</th>
                                <th style="width: 70px;">Đơn vị</th>
                                <th style="width: 100px;">Đơn giá</th>
                                <th style="width: 120px;">Thành tiền</th>
                                <th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody id="ipMaterialsTableBody">
                            <tr>
                                <td colspan="8" class="ip-empty-state">
                                    Chưa có nguyên liệu nào. Nhấn "Thêm nguyên liệu" để bắt đầu.
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="ip-total-section">
                        <div class="ip-total-label">Tổng giá trị đơn hàng:</div>
                        <div class="ip-total-amount" id="ipTotalAmount">0đ</div>
                    </div>

                    <div class="ip-section-title">Xác nhận thông tin</div>

                    <div style="display: flex; align-items: flex-start; gap: 40px; margin-bottom: 20px;">
                        <div>
                            <input type="checkbox" id="chkCreator" style="transform: scale(1.3); margin-right: 8px;" />
                            <label for="chkCreator" style="font-weight: 600;">Xác nhận của người tạo đơn</label>
                            <div id="creatorInfo" style="display:none; margin-top: 8px; font-size: 13px; background:#e5e7eb; padding:8px 12px; border-radius:6px;">
                                <strong>Nguyễn Văn C</strong><br>
                                0123456789
                            </div>
                        </div>

                        <div>
                            <input type="checkbox" id="chkChecker" style="transform: scale(1.3); margin-right: 8px;" />
                            <label for="chkChecker" style="font-weight: 600;">Xác nhận của người kiểm hàng</label>
                            <div id="checkerInfo" style="display:none; margin-top: 8px; font-size: 13px; background:#e5e7eb; padding:8px 12px; border-radius:6px;">
                                <strong>Trần Thị E</strong><br>
                                0123456788
                            </div>
                        </div>

                        <div style="margin-left:auto;">
                            <label style="font-weight:600;">Hình ảnh đơn nhập:</label>
                            <input type="file" id="uploadProof" accept="image/*" style="display:block; margin-top:6px;">
                            <div id="proofPreview" style="margin-top:8px;"></div>
                        </div>
                    </div>


                    <div class="ip-action-buttons">
                        <button class="ip-btn-action ip-btn-back" id="btnBack">Lưu nháp và quay lại</button>
                        <button class="ip-btn-action ip-btn-confirm" id="btnConfirm">Xác nhận nhập hàng</button>
                        <button class="ip-btn-action ip-btn-delete" id="btnDelete">Xóa đơn</button>
                    </div>
                </div>

                <div class="ip-sidebar">
                    <div class="ip-sidebar-card">
                        <h3 class="ip-sidebar-title">Nhà cung cấp hàng đầu</h3>
                        
                        <div class="ip-supplier-list">
                            @foreach (var supplier in Model.SupplierDTOs)
                            {
                                <div class="ip-supplier-card"
                                     data-supplier-id="@supplier.SupplierId"
                                     data-supplier-name="@supplier.Name"
                                     data-supplier-phone="@supplier.Phone"
                                     data-supplier-contact="@supplier.ContactInfo"
                                     data-supplier-email="@supplier.Email"
                                     data-supplier-address="@supplier.Address">

                                    <div class="ip-supplier-avatar">
                                        @supplier.Name.Substring(0, 1)
                                    </div>
                                    <div class="ip-supplier-info">
                                        <div class="ip-supplier-name">@supplier.Name</div>
                                        <div class="ip-supplier-email">@supplier.Email</div>
                                        <div class="ip-supplier-phone">@supplier.Phone</div>
                                    </div>
                                </div>
                            }
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div id="ipSupplierDetail" style="display:none; margin-top:20px;">
            <h3>Chi tiết nhà cung cấp</h3>
            <div><strong>Tên:</strong> <span id="ipDetailName">--</span></div>
            <div><strong>Điện thoại:</strong> <span id="ipDetailPhone">--</span></div>
            <div><strong>Người liên hệ:</strong> <span id="ipDetailContact">--</span></div>
            <div><strong>Email:</strong> <span id="ipDetailEmail">--</span></div>
            <div><strong>Địa chỉ:</strong> <span id="ipDetailAddress">--</span></div>
        </div>

        <!-- Modal Thêm Nguyên Liệu -->
        <div class="ip-modal-overlay" id="ipModalOverlay">
            <div class="ip-modal-container">
                <div class="ip-modal-left">
                    <div class="ip-modal-left-header">
                        <h3>Nguyên Liệu Có Sẵn</h3>
                        <input 
                            type="text" 
                            class="ip-modal-search" 
                            id="ipModalSearch" 
                            placeholder="Tìm theo tên hoặc mã nguyên liệu..."
                        />
                    </div>
                    <div class="ip-modal-materials-list" id="ipModalMaterialsList">
                        <div class="ip-empty-message">Đang tải danh sách nguyên liệu...</div>
                    </div>
                </div>

                <div class="ip-modal-right">
                    <button class="ip-modal-close" id="ipModalClose">&times;</button>
                    <h3 id="ipModalTitle">Thông Tin Nhập Kho</h3>

                    <button class="ip-btn-new-material" id="ipBtnNewMaterial">
                        <span>+</span>
                        <span>Thêm Nguyên Liệu Mới</span>
                    </button>

                    <button class="ip-btn-back-select" id="ipBtnBackSelect" style="display: none;">
                        ← Quay lại chọn nguyên liệu
                    </button>

                    <form class="ip-modal-form" id="ipModalForm">
                        <div class="ip-modal-form-group">
                            <label>Mã Nguyên Liệu</label>
                            <input type="text" id="ipFormCode" readonly disabled />
                            <span class="ip-form-hint">Tự động sinh mã</span>
                        </div>

                        <div class="ip-modal-form-group">
                            <label class="required">Tên Nguyên Liệu</label>
                            <input type="text" id="ipFormName" placeholder="Nhập tên nguyên liệu" disabled />
                        </div>

                        <div class="ip-modal-form-group">
                            <label class="required">Đơn Vị Tính</label>
                            <input type="text" id="ipFormUnit" placeholder="kg, cái, lít..." disabled />
                        </div>

                        <div class="ip-modal-form-group">
                            <label class="required">Số Lượng Nhập</label>
                            <input type="number" id="ipFormQuantity" placeholder="Nhập số lượng" step="0.01" disabled />
                        </div>

                        <div class="ip-modal-form-group">
                            <label class="required">Đơn Giá (VNĐ)</label>
                            <input type="number" id="ipFormUnitPrice" placeholder="Giá/đơn vị" step="1000" disabled />
                        </div>

                        <div class="ip-modal-total-preview" id="ipModalTotalPreview">
                            <p>Thành tiền: <span id="ipModalTotalValue">0đ</span></p>
                        </div>

                        <div class="ip-modal-actions">
                            <button type="button" class="ip-modal-btn-add" id="ipModalBtnAdd" disabled>Thêm</button>
                            <button type="button" class="ip-modal-btn-cancel" id="ipModalBtnCancel">Hủy</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Popup Chọn Nhà Cung Cấp -->
        <div class="supplier-popup-overlay" id="supplierPopupOverlay">
            <div class="supplier-popup-container">
                <div class="supplier-popup-left">
                    <div class="supplier-popup-header">
                        <h2>
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            Chọn Nhà Cung Cấp
                        </h2>
                        <button class="supplier-popup-close" id="supplierPopupClose">&times;</button>
                    </div>

                    <div class="supplier-popup-content">
                        <div class="sp-search">
                            <input type="text" id="spSearchInput" placeholder="Tìm kiếm theo tên hoặc mã NCC..." />
                        </div>

                        <div class="supplier-popup-list" id="supplierPopupList">
                            <div class="sp-list-empty">Đang tải danh sách nhà cung cấp...</div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Warning Dialog -->
        <div class="sp-warning-overlay" id="spWarningOverlay">
            <div class="sp-warning-dialog">
                <div class="sp-warning-header">
                    <div class="sp-warning-icon">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                    </div>
                    <div class="sp-warning-content">
                        <h3>Cảnh báo nhà cung cấp bị hạn chế</h3>
                        <p>
                            Nhà cung cấp <strong id="spWarningName"></strong> hiện đang ở trạng thái 
                            <strong style="color: #dc2626;">Hạn chế</strong>.
                        </p>
                        <p style="margin-top: 8px;">
                            Bạn có chắc chắn muốn chọn nhà cung cấp này không?
                        </p>
                    </div>
                </div>
                <div class="sp-warning-actions">
                    <button class="sp-warning-btn sp-warning-btn-cancel" id="spWarningCancel">Hủy</button>
                    <button class="sp-warning-btn sp-warning-btn-confirm" id="spWarningConfirm">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== DỮ LIỆU TỪ SERVER =====
        const supplierList = @Html.Raw(JsonConvert.SerializeObject(Model.SupplierDTOs));
        const ingredientList = @Html.Raw(JsonConvert.SerializeObject(Model.InventoryIngredientDTOs));
        const warehouseList = @Html.Raw(JsonConvert.SerializeObject(Model.WarehouseDTOs));

        // ===== BIẾN GLOBAL =====
        let ipImportList = [];
        let ipSelectedMaterial = null;
        let ipIsNewMaterial = false;
        let ipSelectedSupplier = null;

        // ===== TOAST NOTIFICATION =====
        function showToast(type, title, message) {
            const container = document.getElementById('ipToastContainer');
            const toast = document.createElement('div');
            toast.className = `ip-toast ${type}`;
            toast.innerHTML = `
                        <div class="ip-toast-icon">${type === 'error' ? '✕' : type === 'warning' ? '⚠' : '✓'}</div>
                        <div class="ip-toast-content">
                            <div class="ip-toast-title">${title}</div>
                            <div class="ip-toast-message">${message}</div>
                        </div>
                    `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // ===== FORMAT CURRENCY =====
        function ipFormatCurrency(value) {
            return parseFloat(value || 0).toLocaleString('vi-VN') + 'đ';
        }

        // ===== TẠO MÃ NGUYÊN LIỆU MỚI KHÔNG TRÙNG =====
        function ipGenerateNewCode() {
            let prefix = "NL";
            let existingCodes = ingredientList.map(i => i.IngredientCode);
            let index = 1;
            let newCode;

            do {
                newCode = `${prefix}-${String(index).padStart(4, '0')}`;
                index++;
            } while (existingCodes.includes(newCode));

            return newCode;
        }

        // ===== NHÀ CUNG CẤP - RENDER DANH SÁCH =====
        function renderSupplierList(data) {
            const container = document.getElementById('supplierPopupList');
            if (!data || data.length === 0) {
                container.innerHTML = `<div class="sp-list-empty">Không tìm thấy nhà cung cấp nào.</div>`;
                return;
            }

            container.innerHTML = data.map(s => `
                        <div class="sp-supplier-card"
                             data-id="${s.SupplierId}"
                             data-name="${s.Name}"
                             data-code="${s.CodeSupplier}"
                             data-phone="${s.Phone || '-'}"
                             data-contact="${s.ContactInfo || '-'}"
                             data-email="${s.Email || '-'}"
                             data-address="${s.Address || '-'}">
                            <div class="sp-card-header">
                                <div class="sp-card-title">
                                    <div class="sp-card-name">${s.Name}</div>
                                    <div class="sp-card-code" style="font-size: 12px; color: #6b7280; margin-top: 4px;">Mã: ${s.CodeSupplier}</div>
                                </div>
                                <div class="sp-card-phone">${s.Phone || '-'}</div>
                            </div>
                            <div class="sp-card-body">
                                <p><strong>Người liên hệ:</strong> ${s.ContactInfo || '-'}</p>
                                <p><strong>Email:</strong> ${s.Email || '-'}</p>
                                <p><strong>Địa chỉ:</strong> ${s.Address || '-'}</p>
                            </div>
                        </div>
                    `).join('');

            // Add click event cho từng card
            document.querySelectorAll('.sp-supplier-card').forEach(card => {
                card.addEventListener('click', () => {
                    const supplier = {
                        SupplierId: card.dataset.id,
                        Name: card.dataset.name,
                        Phone: card.dataset.phone,
                        ContactInfo: card.dataset.contact,
                        Email: card.dataset.email,
                        Address: card.dataset.address,
                        CodeSupplier: card.dataset.code
                    };

                    // ✅ LƯU SUPPLIER ĐÃ CHỌN
                    ipSelectedSupplier = supplier;

                    // ✅ CẬP NHẬT THÔNG TIN NHÀ CUNG CẤP ĐÃ CHỌN
                    document.getElementById('ipSupplierBtnText').textContent = supplier.Name;
                    document.getElementById('ipSupplierDetail').style.display = 'block';
                    document.getElementById('ipDetailName').textContent = supplier.Name;
                    document.getElementById('ipDetailCode').textContent = supplier.CodeSupplier || '-';
                    document.getElementById('ipDetailPhone').textContent = supplier.Phone || '-';
                    document.getElementById('ipDetailContact').textContent = supplier.ContactInfo || '-';
                    document.getElementById('ipDetailEmail').textContent = supplier.Email || '-';
                    document.getElementById('ipDetailAddress').textContent = supplier.Address || '-';

                    // ✅ ĐÓNG POPUP VÀ HIỂN thị THÔNG BÁO
                    spClosePopup();
                    showToast('success', 'Đã chọn nhà cung cấp', `Bạn đã chọn ${supplier.Name}`);
                });
            });
        }

        // ===== NHÀ CUNG CẤP - TÌM KIẾM =====
        function searchSuppliers(keyword) {
            keyword = keyword.trim().toLowerCase();
            const filtered = supplierList.filter(s =>
                s.Name.toLowerCase().includes(keyword) ||
                s.CodeSupplier.toLowerCase().includes(keyword)
            );
            renderSupplierList(filtered);
        }

        // ===== NHÀ CUNG CẤP - MỞ/ĐÓNG POPUP =====
        function spOpenPopup() {
            document.getElementById('supplierPopupOverlay').classList.add('sp-active');
            renderSupplierList(supplierList);
        }

        function spClosePopup() {
            document.getElementById('supplierPopupOverlay').classList.remove('sp-active');
        }

        // ===== NGUYÊN LIỆU - RENDER DANH SÁCH =====
        function ipRenderMaterialsList(searchQuery = '') {
            const container = document.getElementById('ipModalMaterialsList');
            const searchLower = searchQuery.toLowerCase().trim();

            const filtered = ingredientList.filter(m =>
                m.Name.toLowerCase().includes(searchLower) ||
                m.IngredientCode.toLowerCase().includes(searchLower)
            );

            if (filtered.length === 0) {
                container.innerHTML = '<div class="ip-empty-message">Không tìm thấy nguyên liệu phù hợp</div>';
                return;
            }

            container.innerHTML = filtered.map(m => `
                        <div class="ip-material-item" data-code="${m.IngredientCode}">
                            <div class="ip-material-item-header">
                                <div>
                                    <div class="ip-material-item-name">${m.Name}</div>
                                    <div class="ip-material-item-code">${m.IngredientCode}</div>
                                </div>
                                <span class="ip-material-item-unit">${m.Unit || '-'}</span>
                            </div>
                        </div>
                    `).join('');

            // Gắn event click cho từng item
            container.querySelectorAll('.ip-material-item').forEach(item => {
                item.addEventListener('click', function () {
                    container.querySelectorAll('.ip-material-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');

                    const code = this.getAttribute('data-code');
                    const material = ingredientList.find(m => m.IngredientCode === code);
                    ipSelectMaterial(material);
                });
            });
        }

        // ===== NGUYÊN LIỆU - CHỌN NGUYÊN LIỆU CÓ SẴN =====
        function ipSelectMaterial(material) {
            ipSelectedMaterial = material;
            ipIsNewMaterial = false;

            // Hiển thị lại nút "Thêm nguyên liệu mới"
            document.getElementById('ipBtnNewMaterial').style.display = 'inline-flex';
            document.getElementById('ipBtnBackSelect').style.display = 'none';

            // Điền thông tin nguyên liệu đã chọn
            document.getElementById('ipFormCode').value = material.IngredientCode;
            document.getElementById('ipFormName').value = material.Name;
            document.getElementById('ipFormUnit').value = material.Unit;
            document.getElementById('ipFormQuantity').value = '';
            document.getElementById('ipFormUnitPrice').value = '';
            document.getElementById('ipModalTotalPreview').style.display = 'none';

            // Disable các trường thông tin cố định
            document.getElementById('ipFormCode').disabled = true;
            document.getElementById('ipFormName').disabled = true;
            document.getElementById('ipFormUnit').disabled = true;

            // Chỉ cho phép nhập số lượng và đơn giá
            document.getElementById('ipFormQuantity').disabled = false;
            document.getElementById('ipFormUnitPrice').disabled = false;
            document.getElementById('ipModalBtnAdd').disabled = false;

            showToast('success', 'Đã chọn nguyên liệu', `Nhập số lượng và đơn giá cho ${material.Name}`);
        }

        // ===== NGUYÊN LIỆU - CHUYỂN SANG CHẾ ĐỘ THÊM MỚI =====
        function ipSwitchToNewMaterialMode() {
            ipIsNewMaterial = true;
            ipSelectedMaterial = null;

            // Ẩn nút "Thêm nguyên liệu mới", hiện nút "Quay lại"
            document.getElementById('ipBtnNewMaterial').style.display = 'none';
            document.getElementById('ipBtnBackSelect').style.display = 'inline-block';

            // Tạo mã tự động
            const newCode = ipGenerateNewCode();
            document.getElementById('ipFormCode').value = newCode;
            document.getElementById('ipFormName').value = '';
            document.getElementById('ipFormUnit').value = '';
            document.getElementById('ipFormQuantity').value = '';
            document.getElementById('ipFormUnitPrice').value = '';
            document.getElementById('ipModalTotalPreview').style.display = 'none';

            // Disable mã nguyên liệu (tự động), enable các trường khác
            document.getElementById('ipFormCode').disabled = true;
            document.getElementById('ipFormName').disabled = false;
            document.getElementById('ipFormUnit').disabled = false;
            document.getElementById('ipFormQuantity').disabled = false;
            document.getElementById('ipFormUnitPrice').disabled = false;
            document.getElementById('ipModalBtnAdd').disabled = false;

            // Xóa selected từ tất cả items trong danh sách
            document.querySelectorAll('.ip-material-item').forEach(i => i.classList.remove('selected'));

            showToast('success', 'Chế độ thêm mới', 'Nhập thông tin nguyên liệu mới. Mã đã được tạo tự động.');
        }

        // ===== NGUYÊN LIỆU - QUAY LẠI CHẾ ĐỘ CHỌN =====
        function ipBackToSelectMode() {
            ipIsNewMaterial = false;
            ipSelectedMaterial = null;

            // Hiện lại nút "Thêm nguyên liệu mới"
            document.getElementById('ipBtnNewMaterial').style.display = 'inline-flex';
            document.getElementById('ipBtnBackSelect').style.display = 'none';

            // Reset form
            ipResetForm();
            ipRenderMaterialsList();
        }

        // ===== NGUYÊN LIỆU - MỞ/ĐÓNG MODAL =====
        function ipOpenModal() {
            document.getElementById('ipModalOverlay').classList.add('active');
            ipRenderMaterialsList();
            ipResetForm();
        }

        function ipCloseModal() {
            document.getElementById('ipModalOverlay').classList.remove('active');
            ipResetForm();
        }

        function ipResetForm() {
            ipSelectedMaterial = null;
            ipIsNewMaterial = false;

            // Hiện lại nút "Thêm nguyên liệu mới"
            document.getElementById('ipBtnNewMaterial').style.display = 'inline-flex';
            document.getElementById('ipBtnBackSelect').style.display = 'none';

            // Clear form
            document.getElementById('ipModalSearch').value = '';
            document.getElementById('ipFormCode').value = '';
            document.getElementById('ipFormName').value = '';
            document.getElementById('ipFormUnit').value = '';
            document.getElementById('ipFormQuantity').value = '';
            document.getElementById('ipFormUnitPrice').value = '';
            document.getElementById('ipModalTotalPreview').style.display = 'none';

            // Disable tất cả các trường
            document.getElementById('ipFormCode').disabled = true;
            document.getElementById('ipFormName').disabled = true;
            document.getElementById('ipFormUnit').disabled = true;
            document.getElementById('ipFormQuantity').disabled = true;
            document.getElementById('ipFormUnitPrice').disabled = true;
            document.getElementById('ipModalBtnAdd').disabled = true;

            // Xóa selected từ tất cả items
            document.querySelectorAll('.ip-material-item').forEach(i => i.classList.remove('selected'));
        }

        // ===== NGUYÊN LIỆU - KIỂM TRA TÊN TRÙNG =====
        function ipCheckDuplicateName(name) {
            const nameLower = name.toLowerCase().trim();

            // Kiểm tra trùng với nguyên liệu có sẵn trong kho
            const duplicateInStock = ingredientList.find(i =>
                i.Name.toLowerCase() === nameLower
            );

            if (duplicateInStock) {
                return {
                    isDuplicate: true,
                    type: 'stock',
                    message: 'Tên nguyên liệu này đã tồn tại trong kho, vui lòng nhập tên khác.'
                };
            }

            // Kiểm tra trùng với nguyên liệu đã thêm trong danh sách nhập
            const duplicateInImportList = ipImportList.find(item =>
                item.name.toLowerCase() === nameLower
            );

            if (duplicateInImportList) {
                return {
                    isDuplicate: true,
                    type: 'import',
                    message: 'Nguyên liệu này đã có trong danh sách nhập.'
                };
            }

            return { isDuplicate: false };
        }

        // ===== NGUYÊN LIỆU - THÊM VÀO DANH SÁCH NHẬP =====
        function ipAddToImportList() {
            const code = document.getElementById('ipFormCode').value.trim();
            const name = document.getElementById('ipFormName').value.trim();
            const unit = document.getElementById('ipFormUnit').value.trim();
            const quantity = parseFloat(document.getElementById('ipFormQuantity').value);
            const unitPrice = parseFloat(document.getElementById('ipFormUnitPrice').value);

            // Validate thông tin cơ bản
            if (!name) {
                showToast('error', 'Thiếu thông tin', 'Vui lòng nhập tên nguyên liệu');
                return;
            }

            if (!unit) {
                showToast('error', 'Thiếu thông tin', 'Vui lòng nhập đơn vị tính');
                return;
            }

            if (!quantity || quantity <= 0) {
                showToast('error', 'Số lượng không hợp lệ', 'Vui lòng nhập số lượng lớn hơn 0');
                return;
            }

            if (!unitPrice || unitPrice <= 0) {
                showToast('error', 'Đơn giá không hợp lệ', 'Vui lòng nhập đơn giá lớn hơn 0');
                return;
            }

            // Nếu là nguyên liệu mới, kiểm tra tên trùng
            if (ipIsNewMaterial) {
                const duplicateCheck = ipCheckDuplicateName(name);
                if (duplicateCheck.isDuplicate) {
                    showToast('error', 'Tên bị trùng', duplicateCheck.message);
                    return;
                }
            }

            // Tạo object nguyên liệu
            const material = { code, name, unit, quantity, unitPrice, warehouseId: warehouseList.length > 0 ? warehouseList[0].WarehouseId : 0 };

            // Kiểm tra nếu đã có trong danh sách nhập (theo mã)
            const existingIndex = ipImportList.findIndex(item => item.code === code);
            if (existingIndex >= 0) {
                // Cập nhật nguyên liệu có sẵn
                ipImportList[existingIndex] = material;
                showToast('success', 'Đã cập nhật', `Cập nhật thông tin ${name}`);
            } else {
                // Thêm mới
                ipImportList.push(material);
                showToast('success', 'Đã thêm', `Thêm ${name} vào danh sách nhập`);
            }

            // Nếu là nguyên liệu mới => thêm vào danh sách kho để tránh trùng lặp sau này
            if (ipIsNewMaterial) {
                ingredientList.push({
                    IngredientCode: code,
                    Name: name,
                    Unit: unit,
                    ReorderLevel: 0,
                    Batches: []
                });
            }

            // Cập nhật giao diện
            ipRenderImportTable();
            ipUpdateTotal();
            ipCloseModal();
        }

        // ===== BẢNG NHẬP - RENDER =====
        function ipRenderImportTable() {
            const tbody = document.getElementById('ipMaterialsTableBody');

            if (ipImportList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="ip-empty-state">Chưa có nguyên liệu nào. Nhấn "Thêm nguyên liệu" để bắt đầu.</td></tr>';
                ipUpdateTotal();
                return;
            }

            // THÊM DÒNG NÀY - Quan trọng!
            tbody.innerHTML = ipImportList.map((item, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${item.code}</td>
                    <td>${item.name}</td>

                    <!-- CỘT SELECT KHO -->
                            <td>
            <select class="ip-warehouse-select" data-index="${i}">
                ${warehouseList.map(w => `
                    <option value="${w.WarehouseId}" ${w.WarehouseId === item.warehouseId ? 'selected' : ''}>
                        ${w.Name}
                    </option>
                `).join('')}
            </select>
        </td>

                    <td><input type="number" class="ip-quantity-input" value="${item.quantity}" min="0" step="0.01" data-index="${i}" data-field="quantity"></td>
                    <td>${item.unit}</td>
                    <td><input type="number" class="ip-quantity-input" value="${item.unitPrice}" min="0" step="1000" data-index="${i}" data-field="unitPrice"></td>
                    <td style="font-weight:600;color:#10b981;">${ipFormatCurrency(item.quantity * item.unitPrice)}</td>
                    <td><button class="ip-btn-remove" data-index="${i}">×</button></td>
                </tr>
            `).join('');

            // Event cho input số lượng và đơn giá
            tbody.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', e => {
                    const idx = e.target.dataset.index;
                    const field = e.target.dataset.field;
                    const value = parseFloat(e.target.value) || 0;
                    if (value < 0) {
                        e.target.value = 0;
                        return;
                    }
                    ipImportList[idx][field] = value;
                    ipRenderImportTable();
                });
            });

            // Event cho select kho
            tbody.querySelectorAll('.ip-warehouse-select').forEach(select => {
                select.addEventListener('change', e => {
                    const idx = e.target.dataset.index;
                    const warehouseId = parseInt(e.target.value);
                    ipImportList[idx].warehouseId = warehouseId;

                    const warehouseName = warehouseList.find(w => w.WarehouseId === warehouseId)?.Name || '';
                    showToast('success', 'Đã cập nhật kho', `${ipImportList[idx].name} → ${warehouseName}`);
                });
            });

            // Event cho nút xóa
            tbody.querySelectorAll('.ip-btn-remove').forEach(btn => {
                btn.addEventListener('click', e => {
                    const idx = e.target.dataset.index;
                    const removedItem = ipImportList[idx];
                    ipImportList.splice(idx, 1);
                    ipRenderImportTable();
                    showToast('success', 'Đã xóa', `Xóa ${removedItem.name} khỏi danh sách`);
                });
            });

            ipUpdateTotal();
        }

        function ipUpdateTotal() {
            const total = ipImportList.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
            document.getElementById('ipTotalAmount').textContent = ipFormatCurrency(total);
        }


        function ipUpdateModalTotal() {
            const qty = parseFloat(document.getElementById('ipFormQuantity').value) || 0;
            const price = parseFloat(document.getElementById('ipFormUnitPrice').value) || 0;
            const total = qty * price;

            if (qty > 0 && price > 0) {
                document.getElementById('ipModalTotalValue').textContent = ipFormatCurrency(total);
                document.getElementById('ipModalTotalPreview').style.display = 'block';
            } else {
                document.getElementById('ipModalTotalPreview').style.display = 'none';
            }
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener("DOMContentLoaded", () => {
            // Nhà cung cấp
            document.getElementById('ipSupplierBtn').addEventListener('click', spOpenPopup);
            document.getElementById('supplierPopupClose').addEventListener('click', spClosePopup);
            document.getElementById('spSearchInput').addEventListener('input', (e) => searchSuppliers(e.target.value));

            // Nguyên liệu - Modal
            document.getElementById('ipBtnOpenModal').addEventListener('click', ipOpenModal);
            document.getElementById('ipModalClose').addEventListener('click', ipCloseModal);
            document.getElementById('ipModalBtnCancel').addEventListener('click', ipCloseModal);
            document.getElementById('ipModalSearch').addEventListener('input', (e) => ipRenderMaterialsList(e.target.value));
            document.getElementById('ipModalBtnAdd').addEventListener('click', ipAddToImportList);

            // Nút "Thêm nguyên liệu mới"
            document.getElementById('ipBtnNewMaterial').addEventListener('click', ipSwitchToNewMaterialMode);

            // Nút "Quay lại chọn nguyên liệu"
            document.getElementById('ipBtnBackSelect').addEventListener('click', ipBackToSelectMode);

            // Tính toán thành tiền khi nhập số lượng và đơn giá
            document.getElementById('ipFormQuantity').addEventListener('input', ipUpdateModalTotal);
            document.getElementById('ipFormUnitPrice').addEventListener('input', ipUpdateModalTotal);

            // Nút hành động chính
            document.getElementById('btnDelete').addEventListener('click', () => {
                if (ipImportList.length === 0) {
                    showToast('warning', 'Không có gì để xóa', 'Danh sách trống');
                    return;
                }
                if (confirm('Bạn có chắc muốn xóa toàn bộ đơn hàng?')) {
                    ipImportList = [];
                    ipRenderImportTable();
                    showToast('success', 'Đã xóa', 'Đơn hàng đã được xóa');
                }
            });

            document.getElementById('btnBack').addEventListener('click', () => {
                showToast('warning', 'Đã lưu nháp', 'Quay lại trang trước');
                // TODO: Thêm logic lưu nháp và chuyển trang
            });

            document.getElementById('btnConfirm').addEventListener('click', async () => {
                const supplierName = document.getElementById('ipSupplierBtnText').textContent.trim();
                const hasSupplier = supplierName !== "-- Chọn nhà cung cấp --";

                const hasCreator = document.getElementById('chkCreator').checked;
                const hasChecker = document.getElementById('chkChecker').checked;
                const fileInput = document.getElementById('uploadProof');
                const hasImage = fileInput.files.length > 0;

                // ✅ 1. KIỂM TRA ĐIỀU KIỆN BẮT BUỘC
                if (!hasSupplier) {
                    showToast('error', 'Thiếu thông tin', 'Vui lòng chọn nhà cung cấp.');
                    return;
                }
                if (ipImportList.length === 0) {
                    showToast('error', 'Thiếu nguyên liệu', 'Vui lòng thêm ít nhất một nguyên liệu.');
                    return;
                }
                if (!hasCreator) {
                    showToast('error', 'Chưa xác nhận', 'Vui lòng tích xác nhận của người tạo đơn.');
                    return;
                }
                if (!hasChecker) {
                    showToast('error', 'Chưa xác nhận', 'Vui lòng tích xác nhận của người kiểm hàng.');
                    return;
                }
                if (!hasImage) {
                    showToast('error', 'Thiếu minh chứng', 'Vui lòng tải lên hình ảnh đơn nhập.');
                    return;
                }

                // ✅ 2. CHUẨN BỊ DỮ LIỆU
                const importCode = 'PO-2025-001';
                const importDate = document.querySelector('input[type="datetime-local"]').value;
                const supplierId = ipSelectedSupplier ? ipSelectedSupplier.SupplierId : 0;

                const creator = {
                    name: 'Nguyễn Văn C',
                    phone: '0123456789'
                };
                const checker = {
                    name: 'Trần Thị E',
                    phone: '0123456788'
                };

                const proofFile = fileInput.files[0];

                // ✅ 3. TẠO FormData
                const formData = new FormData();
                formData.append('ImportCode', importCode);
                formData.append('ImportDate', importDate);
                formData.append('SupplierId', supplierId.toString());
                formData.append('SupplierName', supplierName);
                formData.append('CreatorName', creator.name);
                formData.append('CreatorPhone', creator.phone);
                formData.append('CheckerName', checker.name);
                formData.append('CheckerPhone', checker.phone);
                formData.append('ProofFile', proofFile);

                // ✅ 4. CONVERT DANH SÁCH NGUYÊN LIỆU (PascalCase)
                const importListFormatted = ipImportList.map(item => ({
                    Code: item.code,
                    Name: item.name,
                    Unit: item.unit,
                    Quantity: item.quantity,
                    UnitPrice: item.unitPrice,
                    WarehouseId: item.warehouseId
                }));

                const importListJson = JSON.stringify(importListFormatted);
                formData.append('ImportList', importListJson);

                // ✅ 5. LOG ĐỂ DEBUG (QUAN TRỌNG!)
                console.log('=== DEBUGGING INFO ===');
                console.log('ipImportList:', ipImportList);
                console.log('importListFormatted:', importListFormatted);
                console.log('ImportList JSON:', importListJson);
                console.log('ImportList JSON length:', importListJson.length);
                console.log('FormData entries:');
                for (let pair of formData.entries()) {
                    if (pair[1] instanceof File) {
                        console.log(pair[0] + ': File - ' + pair[1].name + ' (' + pair[1].size + ' bytes)');
                    } else {
                        console.log(pair[0] + ':', pair[1]);
                    }
                }

                try {
                    // ✅ 6. HIỂN THỊ LOADING
                    showToast('warning', 'Đang xử lý...', 'Vui lòng đợi trong giây lát');

                    // ✅ 7. GỬI REQUEST
                    const response = await fetch('/ImportInventory/SubmitImport', {
                        method: 'POST',
                        body: formData
                    });

                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);

                    // ✅ 8. XỬ LÝ KẾT QUẢ
                    if (response.ok) {
                        const result = await response.json();
                        console.log('✅ Success result:', result);
                        showToast('success', 'Thành công!', result.message || 'Đơn nhập hàng đã được tạo thành công!');

                        // ✅ 9. RESET FORM SAU KHI THÀNH CÔNG
                        ipImportList = [];
                        ipSelectedSupplier = null;
                        ipRenderImportTable();

                        document.getElementById('ipSupplierBtnText').textContent = '-- Chọn nhà cung cấp --';
                        document.getElementById('ipSupplierDetail').style.display = 'none';
                        document.getElementById('chkCreator').checked = false;
                        document.getElementById('chkChecker').checked = false;
                        document.getElementById('creatorInfo').style.display = 'none';
                        document.getElementById('checkerInfo').style.display = 'none';
                        fileInput.value = '';
                        document.getElementById('proofPreview').innerHTML = '';

                    } else {
                        // ✅ 10. XỬ LÝ LỖI TỪ SERVER
                        let errorMessage = 'Không thể gửi đơn nhập hàng.';

                        try {
                            const errorData = await response.json();
                            console.log('❌ Error result:', errorData);
                            errorMessage = errorData.message || errorMessage;
                        } catch (e) {
                            // Nếu response không phải JSON, đọc text
                            const errorText = await response.text();
                            console.log('❌ Error text:', errorText);
                            errorMessage = errorText || errorMessage;
                        }

                        showToast('error', 'Lỗi!', errorMessage);
                    }

                } catch (err) {
                    console.error('❌ Fetch error:', err);
                    console.error('Error details:', err.message);
                    console.error('Stack trace:', err.stack);
                    showToast('error', 'Lỗi kết nối!', 'Không thể kết nối đến server: ' + err.message);
                }
            });


            document.getElementById('chkCreator').addEventListener('change', (e) => {
                const info = document.getElementById('creatorInfo');
                info.style.display = e.target.checked ? 'block' : 'none';
            });

            document.getElementById('chkChecker').addEventListener('change', (e) => {
                const info = document.getElementById('checkerInfo');
                info.style.display = e.target.checked ? 'block' : 'none';
            });


            // Khởi tạo
            renderSupplierList(supplierList);
            ipRenderImportTable();
        });
    </script>
</body>