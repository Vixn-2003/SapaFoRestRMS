@{
    ViewData["Title"] = "Quản lý phân ca";
}

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

<!-- FULLCALENDAR -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />

<style>
    #calendar {
        max-width: 1200px;
        margin: 0 auto;
        height: 700px;
    }
</style>

<div class="container mt-3">
    <h2>Phân ca nhà hàng</h2>
    <button class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#recurringModal">Tạo ca lặp theo tuần</button>
    <div id="calendar"></div>
</div>

<!-- Modal tạo ca lặp -->
<div class="modal fade" id="recurringModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content p-3">
            <h5>Tạo ca lặp theo tuần</h5>
            <form id="recurringForm">
                <div class="mb-2">
                    <label>Nhân viên:</label>
                    <select id="staffSelect" class="form-control"></select>
                </div>
                <div class="mb-2">
                    <label>Template:</label>
                    <select id="templateSelect" class="form-control"></select>
                </div>
                <div class="mb-2">
                    <label>Ngày bắt đầu:</label>
                    <input type="date" name="StartDate" class="form-control" required />
                </div>
                <div class="mb-2">
                    <label>Ngày kết thúc:</label>
                    <input type="date" name="EndDate" class="form-control" required />
                </div>
                <div class="mb-2">
                    <label>Ngày trong tuần:</label><br />
                    <label><input type="checkbox" name="DaysOfWeek" value="Monday"> Thứ 2</label>
                    <label><input type="checkbox" name="DaysOfWeek" value="Tuesday"> Thứ 3</label>
                    <label><input type="checkbox" name="DaysOfWeek" value="Wednesday"> Thứ 4</label>
                    <label><input type="checkbox" name="DaysOfWeek" value="Thursday"> Thứ 5</label>
                    <label><input type="checkbox" name="DaysOfWeek" value="Friday"> Thứ 6</label>
                    <label><input type="checkbox" name="DaysOfWeek" value="Saturday"> Thứ 7</label>
                    <label><input type="checkbox" name="DaysOfWeek" value="Sunday"> Chủ nhật</label>
                </div>
                <button type="submit" class="btn btn-success mt-2">Tạo ca lặp</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal tạo / chỉnh sửa ca -->
<div class="modal fade" id="createShiftModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content p-3">
            <h5>Tạo / Chỉnh sửa ca</h5>
            <form id="createShiftForm">
                <div class="mb-2">
                    <label>Nhân viên:</label>
                    <select id="createStaffSelect" class="form-control" multiple required></select>
                    <small>Giữ CTRL để chọn nhiều nhân viên</small>
                </div>

                <div hidden class="mb-2">
                    <label>Loại ca:</label>
                    <select id="createTemplateSelect" class="form-control"></select>
                </div>

                <div class="mb-2">
                    <label>Thời gian bắt đầu:</label>
                    <input type="datetime-local" id="createStart" class="form-control" required />
                </div>

                <div class="mb-2">
                    <label>Thời gian kết thúc:</label>
                    <input type="datetime-local" id="createEnd" class="form-control" required />
                </div>

                <hr>

                <h6>Lặp lại (chỉ tạo mới ca):</h6>
                <label><input type="radio" name="repeatType" value="none" checked> Không lặp</label><br>
                <label><input type="radio" name="repeatType" value="daily"> Lặp theo ngày</label>
                <input type="number" id="repeatDays" class="form-control mb-2" placeholder="Số ngày lặp">
                <label><input type="radio" name="repeatType" value="weekly"> Lặp theo thứ hàng tuần</label>
                <input type="number" id="repeatWeeks" class="form-control mb-2" placeholder="Số tuần lặp">

                <button type="submit" class="btn btn-success">Lưu ca</button>
                <button type="button" id="deleteShiftBtn" class="btn btn-danger mt-2">Xóa ca</button>
            </form>
        </div>
    </div>
</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        function formatLocal(date) {
            return date.getFullYear()
                + "-" + String(date.getMonth()+1).padStart(2,'0')
                + "-" + String(date.getDate()).padStart(2,'0')
                + "T" + String(date.getHours()).padStart(2,'0')
                + ":" + String(date.getMinutes()).padStart(2,'0');
        }

        // Load nhân viên
        $.get('/Shifts/GetStaffs', function(data){
            data.forEach(s => {
                $('#staffSelect, #createStaffSelect').append(`<option value="${s.staffId}">${s.fullName}</option>`);
            });
        });

        // Load template
        $.get('/Shifts/GetTemplates', function(data){
            data.forEach(t => {
                $('#templateSelect, #createTemplateSelect').append(`<option value="${t.templateId}">${t.name} (${t.shiftType})</option>`);
            });
        });

        var calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: 'timeGridWeek',
            locale: 'vi',
            editable: true,
            selectable: true,
            eventResizableFromStart: true,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek'
            },
            events: function(fetchInfo, successCallback){
                $.get('/Shifts/GetShifts', function(data){
                    data.forEach(e => { e.start = new Date(e.start); e.end = new Date(e.end); });
                    successCallback(data);
                });
            },
            eventDidMount: function(info){
                const colorMap = { 'Sáng':'#FFD700','Chiều':'#00BFFF','Tối':'#8A2BE2','OT':'#FF0000','Nghỉ':'#A9A9A9'};
                info.el.style.backgroundColor = colorMap[info.event.extendedProps.shiftType] || '#3788d8';
            },
            eventDrop: updateShift,
            eventResize: updateShift,
            select: function(info){
                openCreateModal(info.start);
            },
            eventClick: function(info){
                openCreateModal(info.event.start, info.event);
            }
        });

        calendar.render();

        function updateShift(info){
            const dto = {
                StaffId: info.event.extendedProps.staffId,
                StartTime: formatLocal(info.event.start),
                EndTime: formatLocal(info.event.end)
            };
            $.ajax({
                url: '/Shifts/UpdateShift/' + info.event.id,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(dto),
                success: function(){ calendar.refetchEvents(); },
                error: function(xhr){ alert("Lỗi cập nhật ca: " + xhr.responseText); }
            });
        }

        function openCreateModal(dateClicked, event = null){
            $('#createShiftModal').modal('show');
            $('#createStart, #createEnd').prop('disabled', false).val(formatLocal(dateClicked));
            $('#createStaffSelect').val([]).trigger('change');
            $('#createShiftModal').removeData('shiftId');

            if(event){
                $('#createStart').val(formatLocal(event.start));
                $('#createEnd').val(formatLocal(event.end));
                $('#createStaffSelect').val([event.extendedProps.staffId]).trigger('change');
                $('#createShiftModal').data('shiftId', parseInt(event.id)); // set shiftId
            }
        }

        // CREATE / UPDATE ca
        $('#createShiftForm').submit(function(e){
            e.preventDefault();
            const shiftId = $('#createShiftModal').data('shiftId');
            const staffIds = $('#createStaffSelect').val();
            const start = $('#createStart').val();
            const end = $('#createEnd').val();

            if(!staffIds || staffIds.length === 0){
                alert("Vui lòng chọn nhân viên!");
                return;
            }
            if(!start || !end || new Date(start) >= new Date(end)){
                alert("Thời gian bắt đầu phải nhỏ hơn kết thúc!");
                return;
            }

            if(!shiftId){
                // CREATE mới
                const payload = {
                    StaffIds: staffIds.map(x=>parseInt(x)),
                    TemplateId: parseInt($('#createTemplateSelect').val()),
                    StartTime: start,
                    EndTime: end,
                    RepeatType: $('input[name="repeatType"]:checked').val(),
                    RepeatDays: $('#repeatDays').val() ? parseInt($('#repeatDays').val()) : null,
                    RepeatWeeks: $('#repeatWeeks').val() ? parseInt($('#repeatWeeks').val()) : null
                };
                $.ajax({
                    url:'/Shifts/CreateShiftWithRepeat',
                    type:'POST',
                    contentType:'application/json',
                    data: JSON.stringify(payload),
                    success: function(){
                        $('#createShiftModal').modal('hide');
                        calendar.refetchEvents();
                    },
                    error: function(xhr){ alert("Lỗi tạo ca: Người này đang làm ở ca này rồi  " + xhr.responseText); }
                });
            } else {
               // UPDATE ca
    const staffId = $('#createStaffSelect').val()[0]; // chỉ lấy nhân viên đầu tiên
    const dto = {
        StaffId: parseInt(staffId),
        StartTime: start,
        EndTime: end
    };
    $.ajax({
        url:'/Shifts/UpdateShift/' + shiftId,
        type:'PUT',
        contentType:'application/json',
        data: JSON.stringify(dto),
        success: function(){
            $('#createShiftModal').modal('hide');
            calendar.refetchEvents();
        },
        error: function(xhr){
            alert("Lỗi cập nhật ca: " + xhr.responseText);
            calendar.refetchEvents(); // rollback bằng cách reload events
        }
    });
            }
        });

        // DELETE ca
        $('#deleteShiftBtn').click(function(){
            const shiftId = $('#createShiftModal').data('shiftId');
            if(!shiftId) return alert("Chưa chọn ca để xóa!");
            if(confirm("Bạn có chắc muốn xóa ca này?")){
                   $.ajax({
        url:'/Shifts/DeleteShift/' + shiftId,
        type:'DELETE',
        success: function(){
            $('#createShiftModal').modal('hide');
            const event = calendar.getEventById(shiftId);
            if(event) event.remove();
        },
        error: function(xhr){ alert("Lỗi xóa ca: " + xhr.responseText); }
    });

            }
        });

        // Tạo ca lặp tuần
        $('#recurringForm').submit(function(e){
            e.preventDefault();
            const formData = $(this).serializeArray().reduce((o,i)=>{
                if(i.name==='DaysOfWeek') (o.DaysOfWeek??=[]).push(i.value);
                else o[i.name]=i.value;
                return o;
            }, {});
            formData.DaysOfWeek = formData.DaysOfWeek?.join(',')??'';
            $.ajax({
                url:'/Shifts/CreateRecurringShift',
                type:'POST',
                contentType:'application/json',
                data: JSON.stringify(formData),
                success: function(){
                    $('#recurringModal').modal('hide');
                    calendar.refetchEvents();
                },
                error: function(xhr){ alert("Lỗi tạo ca lặp: " + xhr.responseText); }
            });
        });

    });
</script>

