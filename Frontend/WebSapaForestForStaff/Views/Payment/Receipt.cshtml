@{
    ViewData["Title"] = "H√≥a ƒë∆°n thanh to√°n";
    Layout = "~/Views/Shared/_Layout.cshtml";
    int orderId = ViewBag.OrderId ?? 0;
    string apiBaseUrl = ViewBag.ApiBaseUrl as string ?? "https://localhost:7000/api";
}

@section Styles {
    <link rel="stylesheet" href="~/css/payment.css" asp-append-version="true" />
}

<div class="payment-container">
    <div class="receipt-container">
        <!-- Header -->
        <div class="receipt-header">
            <div class="receipt-logo">üçú</div>
            <div class="receipt-restaurant-name">SapaFo Restaurant</div>
            <div class="receipt-info">
                123 ƒê∆∞·ªùng ABC, Qu·∫≠n XYZ, TP.HCM<br>
                ƒêT: 0123 456 789 | Email: info@sapafo.com
            </div>
        </div>

        <!-- Order Info -->
        <div class="receipt-section">
            <div class="receipt-section-title">Th√¥ng tin ƒë∆°n h√†ng</div>
            <div class="receipt-item">
                <span>M√£ ƒë∆°n:</span>
                <span class="fw-bold" id="orderCode">ORD-001</span>
            </div>
            <div class="receipt-item">
                <span>B√†n:</span>
                <span class="fw-bold" id="tableNumber">B√†n 5</span>
            </div>
            <div class="receipt-item">
                <span>Nh√¢n vi√™n:</span>
                <span class="fw-bold" id="staffName">Nguy·ªÖn VƒÉn A</span>
            </div>
            <div class="receipt-item">
                <span>Th·ªùi gian:</span>
                <span class="fw-bold" id="orderTime">-</span>
            </div>
        </div>

        <!-- Items -->
        <div class="receipt-section">
            <div class="receipt-section-title">Danh s√°ch m√≥n</div>
            <div id="receiptItems">
                <!-- Items will be loaded here -->
            </div>
        </div>

        <!-- Summary -->
        <div class="receipt-section">
            <div class="receipt-item">
                <span>T·∫°m t√≠nh:</span>
                <span id="subtotal">0 ‚Ç´</span>
            </div>
            <div class="receipt-item">
                <span>VAT (10%):</span>
                <span id="vat">0 ‚Ç´</span>
            </div>
            <div class="receipt-item">
                <span>Ph√≠ d·ªãch v·ª• (5%):</span>
                <span id="serviceFee">0 ‚Ç´</span>
            </div>
            <div class="receipt-item">
                <span>∆Øu ƒë√£i:</span>
                <span class="text-danger" id="discount">-0 ‚Ç´</span>
            </div>
            <div class="receipt-total">
                <span>T·ªïng c·ªông:</span>
                <span id="total">0 ‚Ç´</span>
            </div>
        </div>

        <!-- Payment Info -->
        <div class="receipt-section">
            <div class="receipt-section-title">Thanh to√°n</div>
            <div class="receipt-item">
                <span>Ph∆∞∆°ng th·ª©c:</span>
                <span class="fw-bold" id="paymentMethod">Ti·ªÅn m·∫∑t</span>
            </div>
            <div class="receipt-item">
                <span>M√£ giao d·ªãch:</span>
                <span class="fw-bold" id="transactionId">TXN-001</span>
            </div>
        </div>

        <!-- Footer -->
        <div class="receipt-footer">
            <div class="mb-2">
                <strong>C·∫£m ∆°n qu√Ω kh√°ch!</strong>
            </div>
            <div>
                H·∫πn g·∫∑p l·∫°i qu√Ω kh√°ch l·∫ßn sau
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="text-center mt-4 no-print">
        <button type="button" 
                class="btn btn-primary me-2" 
                onclick="printReceipt()">
            <i class="bi bi-printer me-2"></i>In h√≥a ƒë∆°n
        </button>
        <button type="button" 
                class="btn btn-outline-primary me-2" 
                onclick="sendReceipt()">
            <i class="bi bi-send me-2"></i>G·ª≠i Email/SMS
        </button>
        <a href="/Payment/OrderSelection" class="btn btn-outline-secondary">
            <i class="bi bi-list-ul me-2"></i>Danh s√°ch ƒë∆°n h√†ng
        </a>
    </div>
</div>

<!-- Toast Notification -->
<div class="toast-container">
    <div id="toastNotification" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Th√¥ng b√°o</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>

@section Scripts {
    <script>
        const apiBaseUrl = '@apiBaseUrl';
        const orderId = @orderId;

        // Load th√¥ng tin h√≥a ƒë∆°n
        async function loadReceipt() {
            try {
                const response = await fetch(`${apiBaseUrl}/orders/${orderId}/details`);
                
                if (!response.ok) {
                    // Mock data
                    const receiptData = getMockReceiptData();
                    renderReceipt(receiptData);
                    return;
                }

                const data = await response.json();
                renderReceipt(data);
            } catch (error) {
                console.error('Error loading receipt:', error);
                const receiptData = getMockReceiptData();
                renderReceipt(receiptData);
            }
        }

        // Mock receipt data
        function getMockReceiptData() {
            return {
                orderCode: 'ORD-001',
                tableNumber: 'B√†n 5',
                staffName: 'Nguy·ªÖn VƒÉn A',
                orderTime: new Date().toLocaleString('vi-VN'),
                items: [
                    { name: 'Ph·ªü B√≤', quantity: 2, price: 85000, total: 170000 },
                    { name: 'B√°nh M√¨ Th·ªãt N∆∞·ªõng', quantity: 1, price: 45000, total: 45000 },
                    { name: 'Coca Cola', quantity: 3, price: 25000, total: 75000 },
                    { name: 'G·ªèi Cu·ªën', quantity: 2, price: 80000, total: 160000 }
                ],
                subtotal: 450000,
                vat: 45000,
                serviceFee: 22500,
                discount: 50000,
                total: 467500,
                paymentMethod: 'Ti·ªÅn m·∫∑t',
                transactionId: 'TXN-' + Date.now()
            };
        }

        // Render h√≥a ƒë∆°n
        function renderReceipt(data) {
            document.getElementById('orderCode').textContent = data.orderCode || 'ORD-001';
            document.getElementById('tableNumber').textContent = data.tableNumber || 'B√†n 5';
            document.getElementById('staffName').textContent = data.staffName || 'Nguy·ªÖn VƒÉn A';
            document.getElementById('orderTime').textContent = data.orderTime || new Date().toLocaleString('vi-VN');

            // Render items
            const itemsContainer = document.getElementById('receiptItems');
            if (data.items && data.items.length > 0) {
                itemsContainer.innerHTML = data.items.map(item => `
                    <div class="receipt-item">
                        <div class="receipt-item-name">${item.name}</div>
                        <div class="receipt-item-quantity">x${item.quantity}</div>
                        <div class="receipt-item-price">${formatCurrency(item.total)}</div>
                    </div>
                `).join('');
            }

            // Render summary
            document.getElementById('subtotal').textContent = formatCurrency(data.subtotal || 0);
            document.getElementById('vat').textContent = formatCurrency(data.vat || 0);
            document.getElementById('serviceFee').textContent = formatCurrency(data.serviceFee || 0);
            document.getElementById('discount').textContent = `-${formatCurrency(data.discount || 0)}`;
            document.getElementById('total').textContent = formatCurrency(data.total || 0);

            // Payment info
            document.getElementById('paymentMethod').textContent = data.paymentMethod || 'Ti·ªÅn m·∫∑t';
            document.getElementById('transactionId').textContent = data.transactionId || 'TXN-001';
        }

        // In h√≥a ƒë∆°n
        function printReceipt() {
            window.print();
        }

        // G·ª≠i bi√™n nh·∫≠n
        async function sendReceipt() {
            try {
                showLoading();

                const response = await fetch(`${apiBaseUrl}/receipt/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        orderId: orderId,
                        method: 'email' // ho·∫∑c 'sms'
                    })
                });

                if (!response.ok) {
                    // Mock success
                    hideLoading();
                    showToast('G·ª≠i bi√™n nh·∫≠n th√†nh c√¥ng! (Mock)', 'success');
                    return;
                }

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    showToast('G·ª≠i bi√™n nh·∫≠n th√†nh c√¥ng!', 'success');
                } else {
                    showToast(result.message || 'G·ª≠i bi√™n nh·∫≠n th·∫•t b·∫°i!', 'error');
                }
            } catch (error) {
                console.error('Error sending receipt:', error);
                hideLoading();
                showToast('G·ª≠i bi√™n nh·∫≠n th√†nh c√¥ng! (Mock)', 'success');
            }
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Show toast
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toastNotification');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            
            const toastInstance = new bootstrap.Toast(toast);
            toastInstance.show();
        }

        // Show loading
        function showLoading() {
            // C√≥ th·ªÉ th√™m spinner
        }

        // Hide loading
        function hideLoading() {
            // Remove spinner
        }

        // Load khi trang ƒë∆∞·ª£c t·∫£i
        document.addEventListener('DOMContentLoaded', function() {
            loadReceipt();
        });
    </script>
}

