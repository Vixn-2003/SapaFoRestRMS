@{
    ViewData["Title"] = "Xác nhận thanh toán";
    Layout = "~/Views/Shared/_LayoutManager.cshtml";
    int orderId = ViewBag.OrderId ?? 0;
    string paymentMethod = ViewBag.PaymentMethod as string ?? "cash";
    string apiBaseUrl = ViewBag.ApiBaseUrl as string ?? "https://localhost:7000/api";
}

<h2 class="mb-3">Xác nhận thanh toán</h2>

<div class="mb-3">
    <a href="/Payment/PaymentMethod?orderId=@orderId" class="btn btn-secondary">
        <i class="bi bi-arrow-left me-2"></i>Quay lại
    </a>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Thông tin thanh toán</h5>
    </div>
    <div class="card-body">

        <!-- Hiển thị tổng tiền -->
        <div class="alert alert-info text-center mb-4">
            <h5 class="mb-0">Tổng tiền cần thanh toán</h5>
            <h3 class="mb-0 fw-bold" id="totalAmount">0 ₫</h3>
        </div>

        <!-- Form thanh toán tiền mặt -->
        <div id="cashPaymentForm" style="display: none;">
            <div class="cash-input-group">
                <label for="cashGiven">
                    <i class="bi bi-cash-coin me-2"></i>Tiền khách đưa
                </label>
                <input type="number" 
                       class="form-control" 
                       id="cashGiven" 
                       placeholder="Nhập số tiền..."
                       oninput="calculateChange()"
                       min="0"
                       step="1000">
            </div>

            <div class="change-display" id="changeDisplay" style="display: none;">
                <div class="change-label">Tiền thối lại</div>
                <div class="change-value" id="changeAmount">0 ₫</div>
            </div>
        </div>

        <!-- Form thanh toán thẻ/Ví điện tử -->
        <div id="digitalPaymentForm" style="display: none;">
            <div class="qr-payment-container">
                <div class="qr-code-placeholder" id="qrCodePlaceholder">
                    <i class="bi bi-qr-code"></i>
                </div>
                <div class="waiting-message">
                    <i class="bi bi-hourglass-split me-2"></i>
                    Đang chờ khách thanh toán...
                </div>
                <p class="text-muted mt-3">
                    Vui lòng quét mã QR hoặc nhập thông tin thanh toán
                </p>
            </div>
        </div>

        <!-- Form chia bill -->
        <div id="splitPaymentForm" style="display: none;">
            <div class="mb-3">
                <label for="splitCount" class="form-label">
                    <i class="bi bi-people me-2"></i>Số người chia
                </label>
                <input type="number" 
                       class="form-control" 
                       id="splitCount" 
                       placeholder="Nhập số người..."
                       min="2"
                       value="2"
                       oninput="calculateSplitAmount()">
            </div>
            <div class="alert alert-info text-center">
                <div class="mb-2">Số tiền mỗi người:</div>
                <h4 class="mb-0 fw-bold" id="splitAmount">0 ₫</h4>
            </div>
        </div>

        <!-- Nút xác nhận -->
        <div class="mt-4">
            <button type="button" 
                    class="btn btn-primary" 
                    id="confirmPaymentBtn"
                    onclick="confirmPayment()">
                <i class="bi bi-check-circle me-2"></i>Xác nhận thanh toán
            </button>
            <button type="button" 
                    class="btn btn-outline-secondary" 
                    onclick="goBack()">
                <i class="bi bi-arrow-left me-2"></i>Quay lại
            </button>
        </div>

        <!-- Nút hủy (cho digital payment) -->
        <div class="mt-3" id="cancelPaymentBtn" style="display: none;">
            <button type="button" 
                    class="btn btn-outline-danger" 
                    onclick="cancelPayment()">
                <i class="bi bi-x-circle me-2"></i>Hủy thanh toán
            </button>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="toast-container">
    <div id="toastNotification" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Thông báo</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>

@section Scripts {
    <script>
        const apiBaseUrl = '@apiBaseUrl';
        const orderId = @orderId;
        const paymentMethod = '@paymentMethod';
        let totalAmount = 0;
        let paymentSessionId = null;

        // Load thông tin đơn hàng
        async function loadOrderInfo() {
            try {
                const response = await fetch(`${apiBaseUrl}/orders/${orderId}/details`);
                
                if (!response.ok) {
                    // Mock data
                    totalAmount = 550000;
                } else {
                    const data = await response.json();
                    totalAmount = data.total || 550000;
                }
                
                document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
                
                // Hiển thị form phù hợp
                showPaymentForm();
            } catch (error) {
                console.error('Error loading order info:', error);
                totalAmount = 550000;
                document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
                showPaymentForm();
            }
        }

        // Hiển thị form thanh toán phù hợp
        function showPaymentForm() {
            document.getElementById('cashPaymentForm').style.display = 'none';
            document.getElementById('digitalPaymentForm').style.display = 'none';
            document.getElementById('splitPaymentForm').style.display = 'none';
            document.getElementById('cancelPaymentBtn').style.display = 'none';

            if (paymentMethod === 'cash') {
                document.getElementById('cashPaymentForm').style.display = 'block';
            } else if (paymentMethod === 'card' || paymentMethod === 'ewallet') {
                document.getElementById('digitalPaymentForm').style.display = 'block';
                document.getElementById('cancelPaymentBtn').style.display = 'block';
                initDigitalPayment();
            } else if (paymentMethod === 'split') {
                document.getElementById('splitPaymentForm').style.display = 'block';
                calculateSplitAmount();
            }
        }

        // Tính tiền thối lại
        function calculateChange() {
            const cashGiven = parseFloat(document.getElementById('cashGiven').value) || 0;
            const change = cashGiven - totalAmount;
            const changeDisplay = document.getElementById('changeDisplay');
            const changeAmount = document.getElementById('changeAmount');

            if (cashGiven > 0) {
                changeDisplay.style.display = 'block';
                
                if (change >= 0) {
                    changeAmount.textContent = formatCurrency(change);
                    changeAmount.parentElement.style.background = '#d1e7dd';
                    changeAmount.parentElement.style.borderColor = '#198754';
                    changeAmount.style.color = '#198754';
                } else {
                    changeAmount.textContent = formatCurrency(Math.abs(change));
                    changeAmount.parentElement.style.background = '#f8d7da';
                    changeAmount.parentElement.style.borderColor = '#dc3545';
                    changeAmount.style.color = '#dc3545';
                    showToast('Số tiền không đủ!', 'error');
                }
            } else {
                changeDisplay.style.display = 'none';
            }
        }

        // Tính số tiền chia bill
        function calculateSplitAmount() {
            const splitCount = parseInt(document.getElementById('splitCount').value) || 2;
            const amountPerPerson = totalAmount / splitCount;
            document.getElementById('splitAmount').textContent = formatCurrency(amountPerPerson);
        }

        // Khởi tạo thanh toán số
        async function initDigitalPayment() {
            try {
                const response = await fetch(`${apiBaseUrl}/payments/initiate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        orderId: orderId,
                        paymentMethod: paymentMethod,
                        amount: totalAmount
                    })
                });

                if (!response.ok) {
                    // Mock payment session
                    paymentSessionId = 'SESSION-' + Date.now();
                    generateMockQRCode();
                    return;
                }

                const result = await response.json();
                paymentSessionId = result.sessionId;
                
                // Hiển thị QR code thật nếu có
                if (result.qrCode) {
                    document.getElementById('qrCodePlaceholder').innerHTML = 
                        `<img src="${result.qrCode}" alt="QR Code" style="max-width: 100%; height: auto;">`;
                } else {
                    generateMockQRCode();
                }
            } catch (error) {
                console.error('Error initiating payment:', error);
                paymentSessionId = 'SESSION-' + Date.now();
                generateMockQRCode();
            }
        }

        // Tạo QR code giả lập
        function generateMockQRCode() {
            const qrPlaceholder = document.getElementById('qrCodePlaceholder');
            qrPlaceholder.innerHTML = `
                <div style="padding: 20px;">
                    <i class="bi bi-qr-code" style="font-size: 4rem; color: #0d6efd;"></i>
                    <div class="mt-3 text-muted">QR Code sẽ hiển thị tại đây</div>
                </div>
            `;
        }

        // Xác nhận thanh toán
        async function confirmPayment() {
            let paymentData = {
                orderId: orderId,
                paymentMethod: paymentMethod,
                amount: totalAmount
            };

            // Thêm dữ liệu cụ thể cho từng phương thức
            if (paymentMethod === 'cash') {
                const cashGiven = parseFloat(document.getElementById('cashGiven').value) || 0;
                if (cashGiven < totalAmount) {
                    showToast('Số tiền khách đưa không đủ!', 'error');
                    return;
                }
                paymentData.cashGiven = cashGiven;
                paymentData.change = cashGiven - totalAmount;
            } else if (paymentMethod === 'split') {
                const splitCount = parseInt(document.getElementById('splitCount').value) || 2;
                paymentData.splitCount = splitCount;
            } else if (paymentMethod === 'card' || paymentMethod === 'ewallet') {
                if (!paymentSessionId) {
                    showToast('Vui lòng đợi hệ thống khởi tạo thanh toán!', 'error');
                    return;
                }
                paymentData.sessionId = paymentSessionId;
            }

            try {
                showLoading();

                const response = await fetch(`${apiBaseUrl}/payments/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                });

                if (!response.ok) {
                    // Mock success
                    setTimeout(() => {
                        hideLoading();
                        window.location.href = `/Payment/PaymentResult?orderId=${orderId}&sessionId=${paymentSessionId || 'MOCK'}`;
                    }, 1500);
                    return;
                }

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    window.location.href = `/Payment/PaymentResult?orderId=${orderId}&sessionId=${result.sessionId || paymentSessionId}`;
                } else {
                    showToast(result.message || 'Thanh toán thất bại!', 'error');
                }
            } catch (error) {
                console.error('Error confirming payment:', error);
                hideLoading();
                // Mock success để demo
                setTimeout(() => {
                    window.location.href = `/Payment/PaymentResult?orderId=${orderId}&sessionId=${paymentSessionId || 'MOCK'}`;
                }, 1000);
            }
        }

        // Hủy thanh toán
        function cancelPayment() {
            if (confirm('Bạn có chắc chắn muốn hủy thanh toán?')) {
                window.location.href = `/Payment/PaymentMethod?orderId=${orderId}`;
            }
        }

        // Quay lại
        function goBack() {
            window.location.href = `/Payment/PaymentMethod?orderId=${orderId}`;
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Show toast
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toastNotification');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            
            const toastInstance = new bootstrap.Toast(toast);
            toastInstance.show();
        }

        // Show loading
        function showLoading() {
            const btn = document.getElementById('confirmPaymentBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...';
        }

        // Hide loading
        function hideLoading() {
            const btn = document.getElementById('confirmPaymentBtn');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Xác nhận thanh toán';
        }

        // Load khi trang được tải
        document.addEventListener('DOMContentLoaded', function() {
            loadOrderInfo();
        });
    </script>
}

