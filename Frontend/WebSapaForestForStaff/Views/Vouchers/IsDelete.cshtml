@using WebSapaForestForStaff.Models
@using WebSapaForestForStaff.Models.VoucherDTO
@model PagedResult<VoucherDto>

@{
    Layout = "~/Views/Shared/_LayoutManager.cshtml";
    var selectedDiscountType = Context.Request.Query["discountType"].ToString();
    var selectedStatus = Context.Request.Query["status"].ToString();

    int safePageSize = Model?.PageSize > 0 ? Model.PageSize : 10;
    int totalCount = Model?.TotalCount ?? 0;
    int currentPage = Model?.PageNumber > 0 ? Model.PageNumber : 1;
    int totalPages = (int)Math.Ceiling((double)totalCount / safePageSize);

    int maxPagesToShow = 5;
    int startPage = Math.Max(currentPage - 2, 1);
    int endPage = Math.Min(startPage + maxPagesToShow - 1, totalPages);
    startPage = Math.Max(endPage - maxPagesToShow + 1, 1);
}
<style>
    select:focus, input:focus {
        box-shadow: 0 0 5px rgba(13, 110, 253, 0.5);
        border-color: #0d6efd;
    }

    select option[selected] {
        background-color: #d1e7dd !important;
        font-weight: 600;
    }

    .form-select, .form-control {
        background-color: #f8f9fa;
    }

        .form-select:hover, .form-control:hover {
            background-color: #ffffff;
        }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Danh sách Voucher đã xóa</h2>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}

<form method="get" asp-action="IsDelete" class="p-4 mb-4 rounded shadow-sm border bg-white" id="filterForm">
    <div class="row align-items-end g-3">
        <!-- Mã voucher -->
        <div class="col-md-3">
            <label for="searchKeyword" class="form-label fw-semibold">Mã Voucher</label>
            <input type="text"
                   class="form-control form-control-sm border-primary"
                   id="searchKeyword"
                   name="searchKeyword"
                   value="@Context.Request.Query["searchKeyword"]"
                   placeholder="Nhập mã voucher...">
        </div>

        <!-- Loại giảm giá -->
        <div class="col-md-3">
            <label for="discountType" class="form-label fw-semibold">Loại Giảm Giá</label>
            <select id="discountType" name="discountType" class="form-select form-select-sm border-success text-dark fw-semibold">
                <option value="">-- Chọn loại giảm giá --</option>
                @{
                    var discountOptions = new List<string> { "Phần trăm", "Giá trị cố định", "Free Shipping" };
                }
                @foreach (var option in discountOptions)
                {
                    <option value="@option" selected="@(option == selectedDiscountType)">
                        @option
                    </option>
                }
            </select>
        </div>

        <!-- Trạng thái -->
        <div class="col-md-3">
            <label for="status" class="form-label fw-semibold">Trạng Thái</label>
            <select id="status" name="status" class="form-select form-select-sm border-info text-dark fw-semibold">
                <option value="">-- Chọn loại Trạng thái --</option>
                @{
                    var statusOptions = new List<string> { "Đang sử dụng", "Sắp ra mắt", "Hết hạn" };
                }
                @foreach (var option in statusOptions)
                {
                    <option value="@option" selected="@(option == selectedStatus)">
                        @option
                    </option>
                }
            </select>
        </div>

        <!-- Nút lọc -->
        <div class="col-md-3 d-flex align-items-center">
            <button type="submit" class="btn btn-primary btn-sm w-100 fw-semibold shadow-sm">
                <i class="mdi mdi-filter"></i> Lọc
            </button>
        </div>
    </div>
</form>


<table class="table table-striped table-bordered">
    <thead class="thead-dark">
        <tr>
            <th>Mã</th>
            <th>Loại Giảm</th>
            <th>Giá trị</th>
            <th>Ngày Bắt đầu</th>
            <th>Ngày Kết thúc</th>
            <th>Đơn Tối thiểu</th>
            <th>Giảm Tối đa</th>
            <th>Thao tác</th>
        </tr>
    </thead>
    <tbody>
        @if (Model?.Data != null && Model.Data.Any())
        {
            @foreach (var voucher in Model.Data)
            {
                <tr>
                    <td>@voucher.Code</td>
                    <td>@voucher.DiscountType</td>
                    <td>
                        @if (voucher.DiscountType?.ToLower() == "phần trăm")
                        {
                            @($"{voucher.DiscountValue:0.#} %")
                        }
                        else
                        {
                            @string.Format("{0:N0} VND", voucher.DiscountValue)
                        }
                    </td>
                    <td>@(voucher.StartDate.HasValue ? voucher.StartDate.Value.ToString("dd-MM-yyyy") : "")</td>
                    <td>@(voucher.EndDate.HasValue ? voucher.EndDate.Value.ToString("dd-MM-yyyy") : "")</td>

                    <td>@string.Format("{0:N0} VND", voucher.MinOrderValue)</td>
                    <td>@string.Format("{0:N0} VND", voucher.MaxDiscount)</td>
                    <td class="text-nowrap">
                        <form asp-action="Restore" asp-controller="Vouchers" method="post" style="display:inline;">
                            <input type="hidden" name="id" value="@voucher.VoucherId" />
                            <button type="submit" class="btn btn-sm btn-success" title="Khôi phục">
                                <i class="mdi mdi-restore"></i>
                            </button>
                        </form>
                    </td>

                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="8" class="text-center">Không có voucher nào đã xóa.</td>
            </tr>
        }
    </tbody>
</table>

@if (totalPages > 1)
{
    <div class="d-flex justify-content-center mt-4">
        <nav aria-label="Page navigation">
            <ul class="pagination">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("IsDelete", new {
                        pageNumber = currentPage - 1,
                        searchKeyword = Context.Request.Query["searchKeyword"].ToString(),
                        discountType = Context.Request.Query["discountType"].ToString(),
                        status = Context.Request.Query["status"].ToString(),
                        pageSize = safePageSize
                    })">Trang trước</a>
                </li>

                @for (int i = startPage; i <= endPage; i++)
                {
                    <li class="page-item @(i == currentPage ? "active" : "")">
                        <a class="page-link" href="@Url.Action("IsDelete", new {
                            pageNumber = i,
                            searchKeyword = Context.Request.Query["searchKeyword"].ToString(),
                            discountType = Context.Request.Query["discountType"].ToString(),
                            status = Context.Request.Query["status"].ToString(),
                            pageSize = safePageSize
                        })">@i</a>
                    </li>
                }

                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("IsDelete", new {
                        pageNumber = currentPage + 1,
                        searchKeyword = Context.Request.Query["searchKeyword"].ToString(),
                        discountType = Context.Request.Query["discountType"].ToString(),
                        status = Context.Request.Query["status"].ToString(),
                        pageSize = safePageSize
                    })">Trang sau</a>
                </li>
            </ul>
        </nav>
    </div>
}
