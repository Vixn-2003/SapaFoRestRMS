@using WebSapaForestForStaff.Models
@using WebSapaForestForStaff.Models.VoucherDTO
@model PagedResult<VoucherDto>

@{
    Layout = null;
    var selectedDiscountType = Context.Request.Query["discountType"].ToString();
    var discountTypes = new List<string> { "", "Percentage", "Fixed", "Free Shipping" };
}
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}

<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f9f9f9;
        padding: 20px;
    }

    h2 {
        color: #2c3e50;
        margin-bottom: 20px;
    }

    form.filter-form {
        background: #fff;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        margin-bottom: 25px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: flex-end;
    }

        form.filter-form > div {
            flex: 1 1 200px;
            display: flex;
            flex-direction: column;
        }

        form.filter-form label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #34495e;
        }

        form.filter-form input[type="text"],
        form.filter-form input[type="number"],
        form.filter-form input[type="date"] {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            transition: border-color 0.2s;
        }

            form.filter-form input[type="text"]:focus,
            form.filter-form input[type="number"]:focus,
            form.filter-form input[type="date"]:focus {
                border-color: #2980b9;
                outline: none;
            }

        form.filter-form button {
            padding: 10px 25px;
            background-color: #2980b9;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

            form.filter-form button:hover {
                background-color: #1f6391;
            }

    table.table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

        table.table thead {
            background-color: #2980b9;
            color: white;
            font-weight: 600;
        }

        table.table th,
        table.table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
            text-align: center;
        }

        table.table tbody tr:hover {
            background-color: #f0f8ff;
        }

    div.pagination {
        margin-top: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        color: #555;
    }

        div.pagination a {
            padding: 8px 16px;
            background-color: #2980b9;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

            div.pagination a:hover {
                background-color: #1f6391;
            }

        div.pagination span {
            font-size: 1rem;
        }


    .search-bar {
        margin-bottom: 20px;
        display: flex;
        justify-content: flex-start;
        gap: 10px;
    }

        .search-bar input[type="text"] {
            padding: 8px 15px;
            width: 300px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

            .search-bar input[type="text"]:focus {
                border-color: #2980b9;
                outline: none;
            }

        .search-bar button {
            padding: 8px 20px;
            background-color: #2980b9;
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

            .search-bar button:hover {
                background-color: #1f6391;
            }

</style>

<h2>Danh sách Voucher</h2>

<div style="margin-bottom: 20px;">
    <a class="btn btn-secondary" href="@Url.Action("IsDelete", "Vouchers")">Xem Voucher đã xóa</a>
</div>
<div style="margin-bottom: 20px;">
    <a class="btn btn-secondary" href="@Url.Action("Create", "Vouchers")">Tạo Voucher mới</a>
</div>
@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger">
        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
        {
            <p>@error.ErrorMessage</p>
        }
    </div>
}

<form method="get" asp-action="Index" class="filter-form">
    <div>
        <label for="keyword">Voucher Code</label>
        <input type="text" id="keyword" name="keyword" value="@Context.Request.Query["keyword"]" placeholder="Nhập mã voucher..." />
    </div>

    <select id="discountType" name="discountType">
        <option value="" selected="@(string.IsNullOrEmpty(selectedDiscountType) ? "selected" : null)">-- Chọn loại giảm giá --</option>
        <option value="Phần trăm" selected="@(selectedDiscountType == "Phần trăm" ? "selected" : null)">Phần trăm</option>
        <option value="Giá trị cố định" selected="@(selectedDiscountType == "Giá trị cố định" ? "selected" : null)">Giá trị cố định</option>
        <option value="Free Shipping" selected="@(selectedDiscountType == "Free Shipping" ? "selected" : null)">Free Shipping</option>
    </select>

    <div>
        <label for="discountValue">Discount Value</label>
        <input type="number" step="0.01" id="discountValue" name="discountValue" value="@Context.Request.Query["discountValue"]" placeholder="Ví dụ: 10" />
    </div>
    <div>
        <label for="startDate">Start Date</label>
        <input type="date" id="startDate" name="startDate" value="@Context.Request.Query["startDate"]" />
    </div>
    <div>
        <label for="endDate">End Date</label>
        <input type="date" id="endDate" name="endDate" value="@Context.Request.Query["endDate"]" />
    </div>
    <div>
        <label for="minOrderValue">Min Order Value</label>
        <input type="number" step="0.01" id="minOrderValue" name="minOrderValue" value="@Context.Request.Query["minOrderValue"]" placeholder="Ví dụ: 100" />
    </div>
    <div>
        <label for="maxDiscount">Max Discount</label>
        <input type="number" step="0.01" id="maxDiscount" name="maxDiscount" value="@Context.Request.Query["maxDiscount"]" placeholder="Ví dụ: 50" />
    </div>
 @*    <div>
        <label for="pageSize">Page Size</label>
        <input type="number" id="pageSize" name="pageSize" value="@Model.PageSize" min="1" />
    </div> *@
    <div>
        <button type="submit">Lọc</button>
    </div>
</form>
<table class="table">
    <thead>
        <tr>
            <th>Code</th>
            <th>Discount Type</th>
            <th>Discount Value</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Min Order Value</th>
            <th>Max Discount</th>
            <th>Actions</th> <!-- Thêm cột Actions -->
        </tr>
    </thead>
    <tbody>
        @foreach (var voucher in Model.Data)
        {
            <tr>
                <td>@voucher.Code</td>
                <td>@voucher.DiscountType</td>
                <td>@voucher.DiscountValue</td>
                <td>@(voucher.StartDate?.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd") ?? "")</td>
                <td>@(voucher.EndDate?.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd") ?? "")</td>
                <td>@voucher.MinOrderValue</td>
                <td>@voucher.MaxDiscount</td>
                <td>
                    <!-- Các nút Detail, Update, Delete -->
                    <a href="@Url.Action("Details", "Vouchers", new { id = voucher.VoucherId, pageNumber = Model.PageNumber })">View Details</a>
                    <a class="btn btn-warning btn-sm" href="@Url.Action("Edit", "Vouchers", new { id = voucher.VoucherId,pageNumber = Model.PageNumber })">Update</a>
                    <a class="btn btn-danger btn-sm" href="@Url.Action("Delete", "Vouchers", new { id = voucher.VoucherId })"
                       onclick="return confirm('Are you sure you want to delete this voucher?');">Delete</a>
                </td>
            </tr>
        }
    </tbody>
</table>

<div class="pagination">
    <span>Trang: @Model.PageNumber / @((Model.TotalCount + Model.PageSize - 1) / Model.PageSize)</span>

    <div>
        @if (Model.PageNumber > 1)
        {
            <a asp-action="Index" asp-route-pageNumber="@(Model.PageNumber - 1)"
               asp-route-discountType="@Context.Request.Query["discountType"]"
               asp-route-discountValue="@Context.Request.Query["discountValue"]"
               asp-route-startDate="@Context.Request.Query["startDate"]"
               asp-route-endDate="@Context.Request.Query["endDate"]"
               asp-route-minOrderValue="@Context.Request.Query["minOrderValue"]"
               asp-route-maxDiscount="@Context.Request.Query["maxDiscount"]"
               asp-route-pageSize="@Model.PageSize">Trang trước</a>
        }

        @if (Model.PageNumber * Model.PageSize < Model.TotalCount)
        {
            <a asp-action="Index" asp-route-pageNumber="@(Model.PageNumber + 1)"
               asp-route-discountType="@Context.Request.Query["discountType"]"
               asp-route-discountValue="@Context.Request.Query["discountValue"]"
               asp-route-startDate="@Context.Request.Query["startDate"]"
               asp-route-endDate="@Context.Request.Query["endDate"]"
               asp-route-minOrderValue="@Context.Request.Query["minOrderValue"]"
               asp-route-maxDiscount="@Context.Request.Query["maxDiscount"]"
               asp-route-pageSize="@Model.PageSize">Trang sau</a>
        }
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.querySelector("form.filter-form");

        form.addEventListener("submit", function (e) {
            const startDate = document.getElementById("startDate").value;
            const endDate = document.getElementById("endDate").value;
            const discountValue = parseFloat(document.getElementById("discountValue").value);
            const minOrderValue = parseFloat(document.getElementById("minOrderValue").value);
            const maxDiscount = parseFloat(document.getElementById("maxDiscount").value);
            const keywordInput = document.getElementById("keyword");

            let errorMessages = [];

            // 1. Validate StartDate <= EndDate
            if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                errorMessages.push("Ngày bắt đầu phải nhỏ hơn hoặc bằng ngày kết thúc.");
            }

            // 2. Validate không âm
            if (!isNaN(discountValue) && discountValue < 0)
                errorMessages.push("Discount Value không được âm.");

            if (!isNaN(minOrderValue) && minOrderValue < 0)
                errorMessages.push("Min Order Value không được âm.");

            if (!isNaN(maxDiscount) && maxDiscount < 0)
                errorMessages.push("Max Discount không được âm.");

            // 3. Trim keyword
            if (keywordInput.value && keywordInput.value.trim() === "") {
                errorMessages.push("Keyword không được chỉ có khoảng trắng.");
            } else {
                keywordInput.value = keywordInput.value.trim(); // trim luôn trước khi submit
            }

            // Nếu có lỗi => ngăn submit và hiển thị
            if (errorMessages.length > 0) {
                e.preventDefault();
                alert(errorMessages.join("\n")); // hoặc show lên UI
            }
        });
    });
</script>
