@{
    Layout = "~/Views/Shared/_LayoutManager.cshtml";

    var selectedDiscountType = Context.Request.Query["discountType"].ToString();
    var selectedStatus = Context.Request.Query["status"].ToString();
}
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Danh sách Voucher</h2>
    <a class="btn btn-success" href="@Url.Action("Create", "Vouchers")">
        <i class="mdi mdi-plus-box"></i> Tạo Voucher mới
    </a>
</div>

@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger">
        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
        {
            <p>@error.ErrorMessage</p>
        }
    </div>
}
<form method="get" asp-action="Index" class="p-4 mb-4 rounded shadow-sm border bg-white" id="filterForm">
    <div class="row align-items-end g-3">
        <!-- Mã voucher -->
        <div class="col-md-3">
            <label for="keyword" class="form-label fw-semibold">Mã Voucher</label>
            <input type="text" class="form-control form-control-sm border-primary"
                   id="keyword" name="keyword"
                   value="@Context.Request.Query["keyword"]"
                   placeholder="Nhập mã voucher...">
        </div>

        <!-- Loại giảm giá -->
        <div class="col-md-3">
            <label for="discountType" class="form-label fw-semibold">Loại Giảm Giá</label>
            <select id="discountType" name="discountType" class="form-select form-select-sm border-success text-dark fw-semibold">
                <option value="">-- Chọn loại giảm giá --</option>
                @{
                    var discountOptions = new List<string> { "Phần trăm", "Giá trị cố định", "Free" };
                }
                @foreach (var option in discountOptions)
                {
                    <option value="@option" selected="@(option == selectedDiscountType)">
                        @option
                    </option>
                }
            </select>
        </div>

        <!-- Giá trị giảm -->
        <div class="col-md-3">
            <label for="discountValue" class="form-label fw-semibold">Giá trị giảm</label>
            <input type="number" class="form-control form-control-sm border-warning"
                   step="0.01" id="discountValue" name="discountValue"
                   value="@Context.Request.Query["discountValue"]"
                   placeholder="VD: 10">
        </div>

        <!-- Ngày bắt đầu -->
        <div class="col-md-3">
            <label for="startDate" class="form-label fw-semibold">Ngày bắt đầu</label>
            <input type="date" class="form-control form-control-sm border-info"
                   id="startDate" name="startDate"
                   value="@Context.Request.Query["startDate"]">
        </div>

        <!-- Ngày kết thúc -->
        <div class="col-md-3">
            <label for="endDate" class="form-label fw-semibold">Ngày kết thúc</label>
            <input type="date" class="form-control form-control-sm border-info"
                   id="endDate" name="endDate"
                   value="@Context.Request.Query["endDate"]">
        </div>

        <!-- Giá trị đơn tối thiểu -->
        <div class="col-md-3">
            <label for="minOrderValue" class="form-label fw-semibold">Giá trị đơn tối thiểu</label>
            <input type="number" class="form-control form-control-sm border-secondary"
                   step="0.01" id="minOrderValue" name="minOrderValue"
                   value="@Context.Request.Query["minOrderValue"]"
                   placeholder="VD: 100">
        </div>

        <!-- Giảm tối đa -->
        <div class="col-md-3">
            <label for="maxDiscount" class="form-label fw-semibold">Giảm tối đa</label>
            <input type="number" class="form-control form-control-sm border-secondary"
                   step="0.01" id="maxDiscount" name="maxDiscount"
                   value="@Context.Request.Query["maxDiscount"]"
                   placeholder="VD: 50">
        </div>

        <!-- Trạng thái -->
        <div class="col-md-3">
            <label for="status" class="form-label fw-semibold">Trạng thái</label>
            <select id="status" name="status" class="form-select form-select-sm border-info text-dark fw-semibold">
                <option value="">-- Chọn trạng thái --</option>
                @{
                    var statusOptions = new List<string> { "Đang sử dụng", "Sắp ra mắt", "Hết hạn" };
                }
                @foreach (var option in statusOptions)
                {
                    <option value="@option" selected="@(option == selectedStatus)">
                        @option
                    </option>
                }
            </select>
        </div>

        <!-- Nút lọc -->
        <div class="col-md-3 d-flex align-items-center">
            <button type="submit" class="btn btn-primary btn-sm w-100 fw-semibold shadow-sm">
                <i class="mdi mdi-filter"></i> Lọc
            </button>
        </div>
    </div>
</form>


<table class="table table-striped table-bordered">
    <thead class="thead-dark">
        <tr>
            <th>Mã</th>
            <th>Loại Giảm</th>
            <th>Giá trị</th>
            <th>Ngày Bắt đầu</th>
            <th>Ngày Kết thúc</th>
            <th>Đơn Tối thiểu</th>
            <th>Giảm Tối đa</th>
            <th>Thao tác</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var voucher in Model.Data)
        {
            <tr>
                <td>@voucher.Code</td>
                <td>@voucher.DiscountType</td>
                <td>
                    @if (voucher.DiscountType?.ToLower() == "phần trăm")
                    {
                        @($"{voucher.DiscountValue:0.#} %")
                    }
                    else
                    {
                        @string.Format("{0:N0} VND", voucher.DiscountValue)
                    }
                </td>
                <td>@voucher.StartDate.ToString("dd-MM-yyyy")</td>
                <td>@voucher.EndDate.ToString("dd-MM-yyyy")</td>

                <td>@string.Format("{0:N0} VND", voucher.MinOrderValue)</td>
                <td>@string.Format("{0:N0} VND", voucher.MaxDiscount)</td>
                <td class="text-nowrap">
                    <a class="btn btn-sm btn-info" href="@Url.Action("Details", "Vouchers", new { id = voucher.VoucherId, pageNumber = Model.PageNumber })">
                        <i class="mdi mdi-eye"></i>
                    </a>
                    <a class="btn btn-sm btn-warning" href="@Url.Action("Edit", "Vouchers", new { id = voucher.VoucherId, pageNumber = Model.PageNumber })">
                        <i class="mdi mdi-pencil"></i>
                    </a>
                    <a class="btn btn-sm btn-danger" href="@Url.Action("Delete", "Vouchers", new { id = voucher.VoucherId })"
                       onclick="return confirm('Bạn có chắc chắn muốn xóa voucher này không?');">
                        <i class="mdi mdi-delete"></i>
                    </a>
                </td>
            </tr>
        }
    </tbody>

</table>

@{
    int totalPages = (Model.TotalCount + Model.PageSize - 1) / Model.PageSize;
    int currentPage = Model.PageNumber;
    int maxPagesToShow = 5;
    int startPage = Math.Max(currentPage - 2, 1);
    int endPage = Math.Min(startPage + maxPagesToShow - 1, totalPages);
    startPage = Math.Max(endPage - maxPagesToShow + 1, 1);
}

<div class="d-flex justify-content-center mt-4">
    <nav aria-label="Page navigation">
        <ul class="pagination">
            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                <a class="page-link" href="@Url.Action("Index", new {
                    pageNumber = currentPage - 1,
                    discountType = Context.Request.Query["discountType"].ToString(),
                    discountValue = Context.Request.Query["discountValue"].ToString(),
                    startDate = Context.Request.Query["startDate"].ToString(),
                    endDate = Context.Request.Query["endDate"].ToString(),
                    minOrderValue = Context.Request.Query["minOrderValue"].ToString(),
                    maxDiscount = Context.Request.Query["maxDiscount"].ToString(),
                    status = Context.Request.Query["status"].ToString(),
                    pageSize = Model.PageSize
                })" tabindex="-1" aria-disabled="@(currentPage == 1 ? "true" : "false")">Trang trước</a>
            </li>

            @for (int i = startPage; i <= endPage; i++)
            {
                <li class="page-item @(i == currentPage ? "active" : "")" aria-current="@(i == currentPage ? "page" : null)">
                    <a class="page-link" href="@Url.Action("Index", new {
                        pageNumber = i,
                        discountType = Context.Request.Query["discountType"].ToString(),
                        discountValue = Context.Request.Query["discountValue"].ToString(),
                        startDate = Context.Request.Query["startDate"].ToString(),
                        endDate = Context.Request.Query["endDate"].ToString(),
                        minOrderValue = Context.Request.Query["minOrderValue"].ToString(),
                        maxDiscount = Context.Request.Query["maxDiscount"].ToString(),
                                            status = Context.Request.Query["status"].ToString(),
                        pageSize = Model.PageSize
                    })">@i</a>
                </li>
            }

            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                <a class="page-link" href="@Url.Action("Index", new {
                    pageNumber = currentPage + 1,
                    discountType = Context.Request.Query["discountType"].ToString(),
                    discountValue = Context.Request.Query["discountValue"].ToString(),
                    startDate = Context.Request.Query["startDate"].ToString(),
                    endDate = Context.Request.Query["endDate"].ToString(),
                    minOrderValue = Context.Request.Query["minOrderValue"].ToString(),
                    maxDiscount = Context.Request.Query["maxDiscount"].ToString(),
                                        status = Context.Request.Query["status"].ToString(),

                    pageSize = Model.PageSize
                })" aria-disabled="@(currentPage == totalPages ? "true" : "false")">Trang sau</a>
            </li>
        </ul>
    </nav>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/vouchers.css" />
}

@section Scripts {
    <script src="~/js/vouchers.js"></script>
    <script>
        // Pass TempData messages to JS
        var successMessage = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(TempData["SuccessMessage"] ?? ""));
        var errorMessage = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(TempData["ErrorMessage"] ?? ""));
        initializeVouchersPage(successMessage, errorMessage);
    </script>
}
